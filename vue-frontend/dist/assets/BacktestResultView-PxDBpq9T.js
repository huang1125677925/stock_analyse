import{d as ct,a as u,z as $,y as ut,j as _t,E as Y,C as ft,c as g,b as t,D as vt,e as s,w as l,i as f,g as Q,t as i,G as pt,H as mt,u as ht,k as T,l as B,Q as bt,L as S,R as wt,S as yt,T as gt,U as xt,f as tt,o as m,_ as kt}from"./index-Dh57P_Gm.js";import{i as N}from"./index-ElshY9iF.js";import{b as St}from"./quantBacktestApi-rCuEnZl2.js";const Lt={class:"backtest-result-view"},Ct={class:"page-header"},Dt={class:"header-content"},Rt={key:0},zt={class:"content-container"},At={class:"basic-stats-section"},Ft={key:0,class:"stats-container"},Mt={class:"top-info-row"},Tt={class:"fund-item"},Bt={class:"period-item"},It={key:0,class:"period-value"},Vt={class:"fund-item"},$t={class:"fund-icon"},Nt={class:"fund-content"},Et={class:"fund-value"},Ot={class:"fund-item"},Gt={class:"fund-icon"},Ut={class:"fund-content"},jt={class:"main-stats"},Pt={class:"main-stat-item"},Wt={class:"stat-icon positive-bg"},Zt={class:"stat-content"},Ht={class:"main-stat-item"},qt={class:"stat-icon info-bg"},Kt={class:"stat-content"},Qt={class:"main-stat-item"},Jt={class:"stat-icon warning-bg"},Xt={class:"stat-content"},Yt={class:"stat-value negative"},te={class:"main-stat-item"},ee={class:"stat-icon success-bg"},ae={class:"stat-content"},se={class:"stat-value"},oe={class:"secondary-stats horizontal-stats"},le={class:"secondary-stat-item"},ie={class:"stat-header"},ne={class:"stat-value"},re={class:"stat-progress"},de={class:"stat-description"},ce={class:"secondary-stat-item"},ue={class:"stat-header"},_e={class:"stat-badge"},fe={class:"stat-value"},ve={class:"stat-description"},pe={class:"secondary-stat-item"},me={class:"stat-header"},he={class:"stat-badge success"},be={class:"stat-value positive"},we={class:"stat-description"},ye={class:"secondary-stat-item"},ge={class:"stat-header"},xe={class:"stat-badge danger"},ke={class:"stat-value negative"},Se={class:"stat-description"},Le={class:"secondary-stat-item"},Ce={class:"stat-header"},De={class:"stat-value"},Re={class:"secondary-stat-item"},ze={class:"stat-header"},Ae={class:"stat-badge info"},Fe={class:"stat-value"},Me={class:"charts-section"},Te={class:"chart-container"},Be={class:"observer-charts-container"},Ie={class:"date-value"},Ve={class:"price-value"},$e={class:"quantity-value"},Ne={class:"amount-value"},Ee={key:1,class:"text-muted"},Oe={key:1,class:"text-muted"},Ge={class:"commission-value"},Ue={class:"remark-text"},je=ct({__name:"BacktestResultView",setup(Pe){const et=_t(),at=ht(),E=u(!1),O=u(""),o=u(null),p=u(null),y=u(null),h=u(null),st=u(null);u("ALL"),u(""),u(""),u(null);const G=u(),U=u(),j=u(),P=u();u();const k=u([]);let C=null,D=null,R=null,z=null;const ot=async()=>{try{const e=await St(O.value);o.value={task_id:e.task_info.task_id,strategy_name:e.task_info.strategy_name,symbol:e.task_info.stock_code,period:{start_date:e.task_info.start_date,end_date:e.task_info.end_date},detailed_data:e.detailed_data,performance:{total_return:e.performance.total_return,annual_return:e.performance.annual_return,max_drawdown:e.performance.max_drawdown,sharpe_ratio:e.performance.sharpe_ratio||0,win_rate:e.performance.win_rate||0,total_trades:e.performance.total_trades,winning_trades:e.performance.winning_trades,losing_trades:e.performance.losing_trades,initial_value:e.performance.initial_value,final_value:e.performance.final_value,volatility:e.performance.volatility||0},portfolio_value:e.detailed_data?.portfolio_values||e.portfolio_value||[],trades:e.detailed_data?.trade_records||e.trades||[]},h.value=e.task_info,o.value&&(k.value=o.value.trades,console.log("filteredTrades.value",k.value));const a=e;a.observer_data&&(p.value={task_info:e.task_info,observer_data:a.observer_data}),(a.raw_data||a.indicator_data)&&(y.value={task_info:e.task_info,raw_data:a.raw_data??{datetime:[],open:[],high:[],low:[],close:[],volume:[]},indicator_data:a.indicator_data??{}},st.value=y.value.indicator_data)}catch(e){console.error("获取回测结果失败:",e),Y.error("获取回测结果失败")}},lt=async()=>{if(await mt(),p.value?.observer_data?.broker?p.value.observer_data.broker.map(e=>e.datetime.split(" ")[0]):y.value?.raw_data&&y.value.raw_data.datetime,P.value&&y.value?.raw_data){z=N(P.value);const e=y.value.raw_data,a=e.datetime||[],d=a.map((c,w)=>e.close[w]),b=[],r=[];p.value?.observer_data?.buysell&&p.value.observer_data.buysell.forEach(c=>{const w=a.findIndex(M=>M.startsWith(c.datetime.split(" ")[0]));w!==-1&&(c.size>0?b.push([w,c.price]):r.push([w,c.price]))});const _=[{name:"收盘价",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#5470c6"},z:5},{name:"买入",type:"scatter",data:b,symbolSize:8,itemStyle:{color:"#F20505"},symbol:"triangle"},{name:"卖出",type:"scatter",data:r,symbolSize:8,itemStyle:{color:"#030008"},symbol:"triangle",symbolRotate:180}];if(y.value?.indicator_data){const c=y.value.indicator_data,w=["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc","#2f4554"];let M=0;const Z=Math.max(...d);Object.keys(c).forEach(x=>{if(c[x]){const H=Math.max(...c[x].filter(n=>n!=null)),V=x.toLowerCase().includes("crossover"),v=x.toLowerCase().includes("signal"),q=H/Z<.5||V||v?1:0,K=w[M++%w.length];_.push({name:x,type:"line",data:c[x],smooth:!0,showSymbol:!1,yAxisIndex:q,lineStyle:{width:1.5,color:K}})}})}const L={tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["收盘价","买入","卖出",...Object.keys(y.value?.indicator_data||{})],type:"scroll",orient:"horizontal",top:0,textStyle:{fontSize:11},pageButtonItemGap:5,pageButtonGap:5},grid:{left:"3%",right:"4%",bottom:"15%",top:"60px",containLabel:!0},xAxis:{type:"category",data:a,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},axisLabel:{rotate:45,interval:"auto",formatter:function(c){return c.substring(5,10)}}},yAxis:[{name:"价格",type:"value",scale:!0,position:"left",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}}},{name:"指标值",type:"value",scale:!0,position:"right",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!1}}],dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:0,start:0,end:100}],series:_};z.setOption(L)}if(G.value&&p.value?.observer_data?.broker){C=N(G.value);const e=p.value.observer_data.broker,a=e.map(_=>_.datetime.split(" ")[0]),d=e.map(_=>_.value),b=e.map(_=>_.cash),r={tooltip:{trigger:"axis",formatter:_=>{let L=`${_[0].axisValue}<br/>`;return _.forEach(c=>{L+=`${c.seriesName}: ¥${c.value.toLocaleString()}<br/>`}),L}},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:_=>`¥${(_/1e3).toFixed(0)}K`}},series:[{name:"总资产",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{color:"#5470c6",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(84, 112, 198, 0.3)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}]}}},{name:"现金",type:"line",data:b,smooth:!0,showSymbol:!1,lineStyle:{color:"#67C23A",width:1.5}}]};C.setOption(r)}if(U.value&&p.value?.observer_data?.timereturn){D=N(U.value);const e=p.value.observer_data.timereturn,a=e.map(r=>r.datetime.split(" ")[0]),d=e.map(r=>r.return),b={tooltip:{trigger:"axis",formatter:r=>`${r[0].axisValue}<br/>收益率: ${r[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:r=>`${r.toFixed(1)}%`}},series:[{name:"收益率",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{color:"#91cc75",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(145, 204, 117, 0.3)"},{offset:1,color:"rgba(145, 204, 117, 0.1)"}]}}}]};D.setOption(b)}if(j.value&&p.value?.observer_data?.drawdown){R=N(j.value);const e=p.value.observer_data.drawdown,a=e.map(r=>r.datetime.split(" ")[0]),d=e.map(r=>r.drawdown*100),b={tooltip:{trigger:"axis",formatter:r=>`${r[0].axisValue}<br/>回撤: ${r[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"5%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:r=>`${r.toFixed(1)}%`}},dataZoom:[{type:"inside",xAxisIndex:0,start:0,end:100},{show:!1,xAxisIndex:0,type:"slider",bottom:0,start:0,end:100}],series:[{name:"回撤",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{color:"#ee6666",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(238, 102, 102, 0.5)"},{offset:1,color:"rgba(238, 102, 102, 0.2)"}]}},emphasis:{focus:"series",itemStyle:{shadowBlur:10,shadowColor:"rgba(238, 102, 102, 0.5)"}}}]};R.setOption(b)}},A=e=>e>0?"positive":e<0?"negative":"",F=e=>e==null?"0.00%":`${e.toFixed(2)}%`,I=e=>e==null?"0.00":e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),it=e=>e>=70?"#67c23a":e>=50?"#e6a23c":"#f56c6c",nt=(e,a)=>Math.abs(e)<.1&&a>1.5?"low-risk":Math.abs(e)<.2&&a>1?"medium-risk":"high-risk",rt=(e,a)=>Math.abs(e)<.1&&a>1.5?"低风险":Math.abs(e)<.2&&a>1?"中风险":"高风险";$(()=>k.value.length),$(()=>k.value.filter(e=>e.type==="buy").length),$(()=>k.value.filter(e=>e.type==="sell").length),$(()=>k.value.reduce((e,a)=>e+a.value,0));const W=e=>e.split("T")[0],J=()=>{at.push({name:"BacktestHistory"})};ut(async()=>{if(O.value=et.params.taskId,!O.value){Y.error("缺少任务ID参数"),J();return}E.value=!0;try{await ot(),await lt()}catch(e){console.error("页面初始化失败:",e)}finally{E.value=!1}});const dt=()=>{C&&(C.dispose(),C=null),D&&(D.dispose(),D=null),R&&(R.dispose(),R=null),z&&(z.dispose(),z=null)};return ft(()=>{dt()}),(e,a)=>{const d=f("el-icon"),b=f("el-button"),r=f("Money"),_=f("Wallet"),L=f("ArrowUp"),c=f("ArrowDown"),w=f("el-progress"),M=f("DataLine"),Z=f("CircleCheck"),x=f("CircleClose"),H=f("Coin"),V=f("el-card"),v=f("el-table-column"),X=f("el-tag"),q=f("el-table"),K=pt("loading");return m(),g("div",Lt,[t("div",Ct,[s(b,{type:"primary",onClick:J,class:"back-button"},{default:l(()=>[s(d,null,{default:l(()=>[s(B(bt))]),_:1}),a[0]||(a[0]=T(" 返回 ",-1))]),_:1}),t("div",Dt,[a[1]||(a[1]=t("h1",null,"回测结果详情",-1)),h.value?(m(),g("p",Rt,i(h.value.strategy_name)+" - "+i(h.value.stock_name)+"("+i(h.value.stock_code)+")",1)):Q("",!0)])]),vt((m(),g("div",zt,[t("div",At,[s(V,{class:"stats-card"},{header:l(()=>[...a[2]||(a[2]=[t("div",{class:"card-header"},[t("span",{class:"card-title"},"回测基本数据")],-1)])]),default:l(()=>[o.value?(m(),g("div",Ft,[t("div",Mt,[t("div",Tt,[t("div",Bt,[a[3]||(a[3]=t("span",{class:"period-label"},"回测区间:",-1)),h.value?(m(),g("span",It,i(W(h.value.start_date))+" 至 "+i(W(h.value.end_date)),1)):Q("",!0)])]),t("div",Vt,[t("div",$t,[s(d,null,{default:l(()=>[s(r)]),_:1})]),t("div",Nt,[a[4]||(a[4]=t("div",{class:"fund-label"},"初始资金",-1)),t("div",Et,"¥"+i(I(h.value?.initial_cash||0)),1)])]),t("div",Ot,[t("div",Gt,[s(d,null,{default:l(()=>[s(_)]),_:1})]),t("div",Ut,[a[5]||(a[5]=t("div",{class:"fund-label"},"最终资金",-1)),t("div",{class:S(["fund-value",A(o.value.performance.final_value-h.value.initial_cash)])}," ¥"+i(I(o.value.performance.final_value)),3)])])]),t("div",jt,[t("div",Pt,[t("div",Wt,[s(d,null,{default:l(()=>[s(B(wt))]),_:1})]),t("div",Zt,[a[6]||(a[6]=t("div",{class:"stat-label"},"总收益率",-1)),t("div",{class:S(["stat-value",A(o.value.performance.total_return)])},i(F(o.value.performance.total_return)),3)])]),t("div",Ht,[t("div",qt,[s(d,null,{default:l(()=>[s(B(yt))]),_:1})]),t("div",Kt,[a[7]||(a[7]=t("div",{class:"stat-label"},"年化收益率",-1)),t("div",{class:S(["stat-value",A(o.value.performance.annual_return)])},i(F(o.value.performance.annual_return)),3)])]),t("div",Qt,[t("div",Jt,[s(d,null,{default:l(()=>[s(B(gt))]),_:1})]),t("div",Xt,[a[8]||(a[8]=t("div",{class:"stat-label"},"最大回撤",-1)),t("div",Yt,i(F(o.value.performance.max_drawdown)),1)])]),t("div",te,[t("div",ee,[s(d,null,{default:l(()=>[s(B(xt))]),_:1})]),t("div",ae,[a[9]||(a[9]=t("div",{class:"stat-label"},"夏普比率",-1)),t("div",se,i(o.value.performance.sharpe_ratio.toFixed(2)),1)])])]),t("div",oe,[t("div",le,[t("div",ie,[a[10]||(a[10]=t("div",{class:"stat-label"},"胜率",-1)),t("div",{class:S(["trend-indicator",o.value.performance.win_rate>=.6?"trend-up":"trend-down"])},[o.value.performance.win_rate>=.6?(m(),tt(d,{key:0},{default:l(()=>[s(L)]),_:1})):(m(),tt(d,{key:1},{default:l(()=>[s(c)]),_:1}))],2)]),t("div",ne,i(F(o.value.performance.win_rate)),1),t("div",re,[s(w,{percentage:o.value.performance.win_rate,"show-text":!1,"stroke-width":6,color:it(o.value.performance.win_rate)},null,8,["percentage","color"])]),t("div",de,i(o.value.performance.win_rate>=.6?"表现优秀":o.value.performance.win_rate>=.4?"表现一般":"需要改进"),1)]),t("div",ce,[t("div",ue,[a[11]||(a[11]=t("div",{class:"stat-label"},"总交易次数",-1)),t("div",_e,[s(d,null,{default:l(()=>[s(M)]),_:1})])]),t("div",fe,i(o.value.performance.total_trades),1),t("div",ve," 交易频率: "+i((o.value.performance.total_trades/252).toFixed(1))+"/年 ",1)]),t("div",pe,[t("div",me,[a[12]||(a[12]=t("div",{class:"stat-label"},"盈利交易",-1)),t("div",he,[s(d,null,{default:l(()=>[s(Z)]),_:1})])]),t("div",be,i(o.value.performance.winning_trades),1),t("div",we," 占比: "+i((o.value.performance.winning_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),t("div",ye,[t("div",ge,[a[13]||(a[13]=t("div",{class:"stat-label"},"亏损交易",-1)),t("div",xe,[s(d,null,{default:l(()=>[s(x)]),_:1})])]),t("div",ke,i(o.value.performance.losing_trades),1),t("div",Se," 占比: "+i((o.value.performance.losing_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),t("div",Le,[t("div",Ce,[a[14]||(a[14]=t("div",{class:"stat-label"},"风险评级",-1)),t("div",{class:S(["risk-level",nt(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)])},[s(d,null,{default:l(()=>[s(_)]),_:1})],2)]),t("div",De,i(rt(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)),1),a[15]||(a[15]=t("div",{class:"stat-description"}," 基于回撤和夏普比率 ",-1))]),t("div",Re,[t("div",ze,[a[16]||(a[16]=t("div",{class:"stat-label"},"收益风险比",-1)),t("div",Ae,[s(d,null,{default:l(()=>[s(H)]),_:1})])]),t("div",Fe,i((Math.abs(o.value.performance.total_return)/Math.abs(o.value.performance.max_drawdown)).toFixed(2)),1),a[17]||(a[17]=t("div",{class:"stat-description"}," 收益/最大回撤 ",-1))])])])):Q("",!0)]),_:1})]),t("div",Me,[s(V,{class:"chart-card main-chart"},{header:l(()=>[...a[18]||(a[18]=[t("div",{class:"card-header"},[t("span",{class:"card-title"},"价格走势与交易信号")],-1)])]),default:l(()=>[t("div",Te,[t("div",{ref_key:"klineChartRef",ref:P,class:"chart main-chart-content"},null,512),a[19]||(a[19]=t("div",{class:"observer-legend",style:{"margin-top":"10px","margin-bottom":"5px","text-align":"center"}},[t("span",{class:"legend-item"},[t("span",{class:"color-dot broker-color"}),T("资金曲线")]),t("span",{class:"legend-item"},[t("span",{class:"color-dot return-color"}),T("收益率曲线")]),t("span",{class:"legend-item"},[t("span",{class:"color-dot drawdown-color"}),T("回撤曲线")])],-1)),t("div",Be,[t("div",{ref_key:"brokerChartRef",ref:G,class:"chart observer-chart"},null,512),t("div",{ref_key:"returnChartRef",ref:U,class:"chart observer-chart"},null,512),t("div",{ref_key:"drawdownChartRef",ref:j,class:"chart observer-chart"},null,512)])])]),_:1})]),s(q,{data:k.value,stripe:"",style:{width:"100%"},"default-sort":{prop:"datetime",order:"descending"},class:"trades-table"},{default:l(()=>[s(v,{type:"index",label:"#","min-width":"60"}),s(v,{prop:"datetime",label:"交易日期","min-width":"120",sortable:""},{default:l(n=>[t("span",Ie,i(W(n.row.datetime)),1)]),_:1}),s(v,{label:"操作","min-width":"80",align:"center"},{default:l(n=>[s(X,{type:n.row.type==="buy"?"success":"danger",size:"small",effect:"dark"},{default:l(()=>[T(i(n.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),s(v,{prop:"price",label:"价格","min-width":"100",sortable:"",align:"right"},{default:l(n=>[t("span",Ve,"¥"+i(Number(n.row.price??0).toFixed(2)),1)]),_:1}),s(v,{prop:"size",label:"数量","min-width":"100",align:"right"},{default:l(n=>[t("span",$e,i(Number(n.row.size??0).toLocaleString()),1)]),_:1}),s(v,{prop:"value",label:"成本","min-width":"120",sortable:"",align:"right"},{default:l(n=>[t("span",Ne,"¥"+i(Number(n.row.value??0).toLocaleString()),1)]),_:1}),s(v,{prop:"pnl",label:"盈亏","min-width":"120",sortable:"",align:"right"},{default:l(n=>[n.row.type==="sell"?(m(),g("span",{key:0,class:S(A(n.row.pnl||0))},i(I(n.row.pnl)),3)):(m(),g("span",Ee,"-"))]),_:1}),s(v,{label:"收益率","min-width":"100",align:"right"},{default:l(n=>[n.row.type==="sell"?(m(),g("span",{key:0,class:S(A(n.row.pnl_pct||0))},i(F(n.row.pnl_pct||0)),3)):(m(),g("span",Oe,"-"))]),_:1}),s(v,{label:"手续费","min-width":"100",align:"right"},{default:l(n=>[t("span",Ge,"¥"+i(I(Number(n.row.commission??0))),1)]),_:1}),s(v,{label:"备注","min-width":"120"},{default:l(n=>[t("span",Ue,i(n.row.type==="buy"?"策略买入信号":"策略卖出信号"),1)]),_:1})]),_:1},8,["data"])])),[[K,E.value]])])}}}),qe=kt(je,[["__scopeId","data-v-542aaf8b"]]);export{qe as default};
