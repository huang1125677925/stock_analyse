import{d as oe,a as w,B as Z,f as L,w as t,i as c,c as b,g as P,e,k as i,t as r,b as l,F as ne,A as re,L as Y,E as I,o as p,_ as ie,r as W,y as fe,H as ge,D as ke,G as be,h as X,u as ye}from"./index-CPDmQmJM.js";import{b as we,d as he,g as Ce,r as $e,a as xe}from"./quantBacktestApi-BtJ27qoP.js";const ze={key:0,class:"loading-container"},De={key:1,class:"result-container"},Se={key:0,class:"strategy-params"},Ve={class:"metric-item"},Te={class:"metric-value"},Be={class:"metric-item"},Ne={class:"metric-value"},Le={class:"metric-item"},Re={class:"metric-item"},Fe={class:"metric-item"},Ue={class:"metric-value"},Ie={class:"metric-item"},Pe={class:"metric-value negative"},Ee={class:"metric-item"},He={class:"metric-value"},Me={class:"metric-item"},je={class:"metric-value"},qe={class:"metric-item"},Ae={class:"metric-value"},Ge={class:"metric-item"},Oe={class:"metric-value positive"},Ye={class:"metric-item"},Je={class:"metric-value negative"},Ke={class:"card-header"},Qe={class:"trade-count"},We={key:2,class:"error-container"},Xe=oe({__name:"BacktestResultDialog",props:{visible:{type:Boolean},taskId:{}},emits:["update:visible"],setup(ee,{emit:J}){const m=ee,f=J,n=w(null),B=w(!1),d=w(""),R=async()=>{if(!m.taskId){d.value="任务ID不能为空";return}B.value=!0,d.value="",n.value=null;try{n.value=await we(m.taskId)}catch(_){console.error("加载回测结果失败:",_),d.value=_.message||"加载回测结果失败",I.error("加载回测结果失败")}finally{B.value=!1}},D=()=>{f("update:visible",!1),n.value=null,d.value=""};Z(()=>m.visible,_=>{_&&m.taskId&&R()});const C=_=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}).format(_),S=_=>_==null?"-":`${_.toFixed(2)}%`,V=_=>new Date(_).toLocaleString("zh-CN"),N=_=>_>0?"positive":_<0?"negative":"";return(_,u)=>{const $=c("el-skeleton"),y=c("el-descriptions-item"),M=c("el-descriptions"),E=c("el-card"),k=c("el-col"),F=c("el-row"),x=c("el-table-column"),j=c("el-tag"),K=c("el-table"),q=c("el-button"),Q=c("el-result"),A=c("el-dialog");return p(),L(A,{"model-value":_.visible,"onUpdate:modelValue":D,title:"回测结果详情",width:"90%","close-on-click-modal":!1,"before-close":D},{footer:t(()=>[e(q,{onClick:D},{default:t(()=>[...u[16]||(u[16]=[i("关闭",-1)])]),_:1})]),default:t(()=>[B.value?(p(),b("div",ze,[e($,{rows:10,animated:""})])):n.value?(p(),b("div",De,[e(E,{class:"info-card",shadow:"never"},{header:t(()=>[...u[0]||(u[0]=[l("div",{class:"card-header"},[l("span",null,"基本信息")],-1)])]),default:t(()=>[e(M,{column:3,border:""},{default:t(()=>[e(y,{label:"任务ID"},{default:t(()=>[i(r(n.value.task_info.task_id),1)]),_:1}),e(y,{label:"策略名称"},{default:t(()=>[i(r(n.value.task_info.strategy_name),1)]),_:1}),e(y,{label:"股票代码"},{default:t(()=>[i(r(n.value.task_info.stock_code),1)]),_:1}),e(y,{label:"股票名称"},{default:t(()=>[i(r(n.value.task_info.stock_name),1)]),_:1}),e(y,{label:"开始日期"},{default:t(()=>[i(r(n.value.task_info.start_date),1)]),_:1}),e(y,{label:"结束日期"},{default:t(()=>[i(r(n.value.task_info.end_date),1)]),_:1}),e(y,{label:"初始资金"},{default:t(()=>[i(r(C(n.value.task_info.initial_cash)),1)]),_:1}),e(y,{label:"手续费率"},{default:t(()=>[i(r(S(n.value.task_info.commission)),1)]),_:1}),e(y,{label:"创建时间"},{default:t(()=>[i(r(V(n.value.task_info.created_at)),1)]),_:1}),e(y,{label:"完成时间"},{default:t(()=>[i(r(V(n.value.task_info.completed_at)),1)]),_:1})]),_:1}),n.value.task_info.strategy_params&&Object.keys(n.value.task_info.strategy_params).length>0?(p(),b("div",Se,[u[1]||(u[1]=l("h4",null,"策略参数",-1)),e(M,{column:2,border:""},{default:t(()=>[(p(!0),b(ne,null,re(n.value.task_info.strategy_params,(g,H)=>(p(),L(y,{key:H,label:H},{default:t(()=>[i(r(g),1)]),_:2},1032,["label"]))),128))]),_:1})])):P("",!0)]),_:1}),e(E,{class:"performance-card",shadow:"never"},{header:t(()=>[...u[2]||(u[2]=[l("div",{class:"card-header"},[l("span",null,"绩效指标")],-1)])]),default:t(()=>[e(F,{gutter:16},{default:t(()=>[e(k,{span:6},{default:t(()=>[l("div",Ve,[u[3]||(u[3]=l("div",{class:"metric-label"},"初始价值",-1)),l("div",Te,r(C(n.value.performance.initial_value)),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Be,[u[4]||(u[4]=l("div",{class:"metric-label"},"最终价值",-1)),l("div",Ne,r(C(n.value.performance.final_value)),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Le,[u[5]||(u[5]=l("div",{class:"metric-label"},"总收益率",-1)),l("div",{class:Y(["metric-value",N(n.value.performance.total_return)])},r(S(n.value.performance.total_return)),3)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Re,[u[6]||(u[6]=l("div",{class:"metric-label"},"年化收益率",-1)),l("div",{class:Y(["metric-value",N(n.value.performance.annual_return)])},r(S(n.value.performance.annual_return)),3)])]),_:1})]),_:1}),e(F,{gutter:16},{default:t(()=>[e(k,{span:6},{default:t(()=>[l("div",Fe,[u[7]||(u[7]=l("div",{class:"metric-label"},"夏普比率",-1)),l("div",Ue,r(n.value.performance.sharpe_ratio!==null?n.value.performance.sharpe_ratio.toFixed(4):"-"),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ie,[u[8]||(u[8]=l("div",{class:"metric-label"},"最大回撤",-1)),l("div",Pe,r(S(n.value.performance.max_drawdown)),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ee,[u[9]||(u[9]=l("div",{class:"metric-label"},"波动率",-1)),l("div",He,r(n.value.performance.volatility!==null?S(n.value.performance.volatility):"-"),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Me,[u[10]||(u[10]=l("div",{class:"metric-label"},"总交易次数",-1)),l("div",je,r(n.value.performance.total_trades),1)])]),_:1})]),_:1}),e(F,{gutter:16},{default:t(()=>[e(k,{span:6},{default:t(()=>[l("div",qe,[u[11]||(u[11]=l("div",{class:"metric-label"},"胜率",-1)),l("div",Ae,r(n.value.performance.win_rate!==null?S(n.value.performance.win_rate):"-"),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ge,[u[12]||(u[12]=l("div",{class:"metric-label"},"盈利交易",-1)),l("div",Oe,r(n.value.performance.winning_trades),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ye,[u[13]||(u[13]=l("div",{class:"metric-label"},"亏损交易",-1)),l("div",Je,r(n.value.performance.losing_trades),1)])]),_:1}),e(k,{span:6})]),_:1})]),_:1}),n.value.detailed_data.trade_records.length>0?(p(),L(E,{key:0,class:"trades-card",shadow:"never"},{header:t(()=>[l("div",Ke,[u[14]||(u[14]=l("span",null,"交易记录",-1)),l("span",Qe,"共 "+r(n.value.detailed_data.trade_records.length)+" 笔交易",1)])]),default:t(()=>[e(K,{data:n.value.detailed_data.trade_records,stripe:"",style:{width:"100%"},"max-height":"400"},{default:t(()=>[e(x,{prop:"datetime",label:"交易时间","min-width":"160"},{default:t(g=>[i(r(V(g.row.datetime)),1)]),_:1}),e(x,{prop:"type",label:"交易类型","min-width":"100"},{default:t(g=>[e(j,{type:g.row.type==="buy"?"success":"danger"},{default:t(()=>[i(r(g.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),e(x,{prop:"size",label:"数量","min-width":"100"}),e(x,{prop:"price",label:"价格","min-width":"120"},{default:t(g=>[i(r(C(g.row.price)),1)]),_:1}),e(x,{prop:"value",label:"交易金额","min-width":"140"},{default:t(g=>[i(r(C(g.row.value)),1)]),_:1}),e(x,{prop:"commission",label:"手续费","min-width":"120"},{default:t(g=>[i(r(C(g.row.commission)),1)]),_:1})]),_:1},8,["data"])]),_:1})):P("",!0)])):d.value?(p(),b("div",We,[e(Q,{icon:"error",title:"加载失败","sub-title":d.value},{extra:t(()=>[e(q,{type:"primary",onClick:R},{default:t(()=>[...u[15]||(u[15]=[i("重试",-1)])]),_:1})]),_:1},8,["sub-title"])])):P("",!0)]),_:1},8,["model-value"])}}}),Ze=ie(Xe,[["__scopeId","data-v-ed8eda27"]]),et={class:"backtest-history-view"},tt={class:"filter-panel"},at={class:"card-header"},lt={class:"task-list"},st={class:"card-header"},ot={class:"header-actions"},nt={key:1},rt={key:0,class:"negative"},it={key:1},dt={key:0,class:"positive"},ut={key:1},ct={class:"pagination-container"},_t={key:0,class:"task-detail"},mt={class:"negative"},pt={class:"task-actions",style:{"margin-top":"20px"}},vt=oe({__name:"BacktestHistoryView",setup(ee){const J=ye(),m=W({strategyName:"",symbol:"",status:""}),f=W({page:1,pageSize:10,total:0}),n=w([]),B=w([]),d=w(null),R=w(!1),D=w(!1),C=w(!1),S=w(""),V=w(new Set),N=w(new Set),_=W({tasks:[]}),u=s=>{const a=B.value.find(v=>v.name===s);return a?a.description:s},$=async()=>{R.value=!0;try{const s={offset:(f.page-1)*f.pageSize,limit:f.pageSize,...m.strategyName&&{strategy_name:m.strategyName},...m.symbol&&{stock_code:m.symbol},...m.status&&{status:m.status}},a=await he(s);console.log("result.tasks",a.tasks),_.tasks=a.tasks||[],n.value=a.tasks||[],await ge(),f.total=a.total}catch(s){console.error("加载任务列表失败:",s),I.error("加载任务列表失败")}finally{R.value=!1}},y=async()=>{try{const s=await Ce();B.value=s}catch(s){console.error("加载策略列表失败:",s)}},M=()=>{f.page=1,$()},E=()=>{m.strategyName="",m.symbol="",m.status="",f.page=1,$()},k=()=>{$()},F=async s=>{V.value.add(s);try{if(await $e(s),I.success("回测任务已启动"),await $(),d.value&&d.value.task_id===s){const a=_.tasks.find(v=>v.task_id===s);a&&(d.value=a)}}catch(a){console.error("运行回测任务失败:",a),I.error("运行回测任务失败")}finally{V.value.delete(s)}},x=async s=>{N.value.add(s);try{const a=await xe(s),v=_.tasks.findIndex(U=>U.task_id===s);v!==-1&&(_.tasks[v].status=a.status,a.completed_at&&(_.tasks[v].completed_at=a.completed_at));const z=n.value.findIndex(U=>U.task_id===s);z!==-1&&(n.value[z].status=a.status,a.completed_at&&(n.value[z].completed_at=a.completed_at)),d.value&&d.value.task_id===s&&(d.value.status=a.status,a.completed_at&&(d.value.completed_at=a.completed_at)),I.success("状态已更新")}catch(a){console.error("查询任务状态失败:",a),I.error("查询任务状态失败")}finally{N.value.delete(s)}},j=s=>{J.push(`/backtest-result/${s}`)},K=s=>{d.value=s,D.value=!0},q=s=>{f.pageSize=s,f.page=1,$()},Q=s=>{f.page=s,$()},A=s=>{switch(s){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},g=s=>{switch(s){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},H=s=>s>0?"positive":s<0?"negative":"",G=s=>s==null?"-":`${s.toFixed(2)}%`,te=s=>new Date(s).toLocaleString("zh-CN");return Z(n,s=>{console.log("taskList 发生变化，新长度:",s.length)},{deep:!0}),Z(()=>_.tasks,s=>{console.log("tableData.tasks 发生变化，新长度:",s.length),console.log("tableData.tasks 内容:",s)},{deep:!0}),fe(async()=>{await Promise.all([y(),$()])}),(s,a)=>{const v=c("el-button"),z=c("el-option"),U=c("el-select"),O=c("el-form-item"),de=c("el-input"),ue=c("el-form"),ae=c("el-card"),h=c("el-table-column"),le=c("el-tag"),ce=c("el-table"),_e=c("el-pagination"),T=c("el-descriptions-item"),me=c("el-descriptions"),pe=c("el-dialog"),ve=be("loading");return p(),b("div",et,[a[25]||(a[25]=l("div",{class:"page-header"},[l("h1",null,"回测历史"),l("p",null,"查看历史回测任务，监控状态和查看结果")],-1)),l("div",tt,[e(ae,null,{header:t(()=>[l("div",at,[a[13]||(a[13]=l("span",null,"筛选条件",-1)),e(v,{type:"primary",onClick:k},{default:t(()=>[...a[12]||(a[12]=[i("刷新",-1)])]),_:1})])]),default:t(()=>[e(ue,{model:m,inline:"",class:"filter-form"},{default:t(()=>[e(O,{label:"策略名称"},{default:t(()=>[e(U,{modelValue:m.strategyName,"onUpdate:modelValue":a[0]||(a[0]=o=>m.strategyName=o),placeholder:"全部策略",clearable:"",style:{width:"150px"}},{default:t(()=>[(p(!0),b(ne,null,re(B.value,o=>(p(),L(z,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(O,{label:"股票代码"},{default:t(()=>[e(de,{modelValue:m.symbol,"onUpdate:modelValue":a[1]||(a[1]=o=>m.symbol=o),placeholder:"请输入股票代码",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(O,{label:"状态"},{default:t(()=>[e(U,{modelValue:m.status,"onUpdate:modelValue":a[2]||(a[2]=o=>m.status=o),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:t(()=>[e(z,{label:"已创建",value:"created"}),e(z,{label:"运行中",value:"running"}),e(z,{label:"已完成",value:"completed"}),e(z,{label:"执行失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),e(O,null,{default:t(()=>[e(v,{type:"primary",onClick:M},{default:t(()=>[...a[14]||(a[14]=[i("查询",-1)])]),_:1}),e(v,{onClick:E},{default:t(()=>[...a[15]||(a[15]=[i("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),l("div",lt,[e(ae,null,{header:t(()=>[l("div",st,[a[17]||(a[17]=l("span",null,"回测任务列表",-1)),l("div",ot,[e(v,{type:"primary",onClick:a[3]||(a[3]=o=>s.$router.push("/backtest-strategy"))},{default:t(()=>[...a[16]||(a[16]=[i("创建新任务",-1)])]),_:1})])])]),default:t(()=>[ke((p(),L(ce,{data:_.tasks,stripe:"",style:{width:"100%"},onRowClick:K,class:"full-width-table"},{default:t(()=>[e(h,{prop:"stock_code",label:"股票代码","min-width":"100",align:"center"}),e(h,{prop:"stock_name",label:"股票名称","min-width":"100",align:"center"}),e(h,{label:"策略","min-width":"120"},{default:t(o=>[i(r(u(o.row.strategy_name)),1)]),_:1}),e(h,{label:"状态",width:"100"},{default:t(o=>[e(le,{type:A(o.row.status)},{default:t(()=>[i(r(g(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),e(h,{prop:"start_date",label:"回测开始时间","min-width":"100",align:"center"}),e(h,{prop:"end_date",label:"回测结束时间","min-width":"100",align:"center"}),e(h,{prop:"frequency",label:"回测数据频率","min-width":"100",align:"center"}),e(h,{label:"总收益率","min-width":"120",align:"center"},{default:t(o=>[o.row.result_summary?.total_return!==void 0?(p(),b("span",{key:0,class:Y(H(o.row.result_summary?.total_return))},r(G(o.row.result_summary?.total_return)),3)):(p(),b("span",nt,"-"))]),_:1}),e(h,{label:"最大回撤","min-width":"100"},{default:t(o=>[o.row.result_summary?.max_drawdown!==void 0?(p(),b("span",rt,r(G(o.row.result_summary?.max_drawdown)),1)):(p(),b("span",it,"-"))]),_:1}),e(h,{label:"夏普比率","min-width":"100"},{default:t(o=>[o.row.result_summary?.sharpe_ratio!==void 0?(p(),b("span",dt,r(o.row.result_summary?.sharpe_ratio),1)):(p(),b("span",ut,"-"))]),_:1}),e(h,{label:"操作","min-width":"250",fixed:"right",align:"center"},{default:t(o=>[e(v,{type:"primary",size:"small",onClick:X(se=>F(o.row.task_id),["stop"]),disabled:o.row.status!=="created",loading:V.value.has(o.row.task_id)},{default:t(()=>[...a[18]||(a[18]=[i(" 运行 ",-1)])]),_:2},1032,["onClick","disabled","loading"]),e(v,{type:"info",size:"small",onClick:X(se=>x(o.row.task_id),["stop"]),loading:N.value.has(o.row.task_id)},{default:t(()=>[...a[19]||(a[19]=[i(" 查询状态 ",-1)])]),_:2},1032,["onClick","loading"]),e(v,{type:"success",size:"small",onClick:X(se=>j(o.row.task_id),["stop"]),disabled:o.row.status!=="completed"},{default:t(()=>[...a[20]||(a[20]=[i(" 查看结果 ",-1)])]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[ve,R.value]]),l("div",ct,[e(_e,{"current-page":f.page,"onUpdate:currentPage":a[4]||(a[4]=o=>f.page=o),"page-size":f.pageSize,"onUpdate:pageSize":a[5]||(a[5]=o=>f.pageSize=o),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:q,onCurrentChange:Q},null,8,["current-page","page-size","total"])])]),_:1})]),e(pe,{modelValue:D.value,"onUpdate:modelValue":a[10]||(a[10]=o=>D.value=o),title:"任务详情",width:"800px","close-on-click-modal":!1},{footer:t(()=>[e(v,{onClick:a[9]||(a[9]=o=>D.value=!1)},{default:t(()=>[...a[24]||(a[24]=[i("关闭",-1)])]),_:1})]),default:t(()=>[d.value?(p(),b("div",_t,[e(me,{column:2,border:""},{default:t(()=>[e(T,{label:"任务ID"},{default:t(()=>[i(r(d.value.task_id),1)]),_:1}),e(T,{label:"策略名称"},{default:t(()=>[i(r(d.value.strategy_name),1)]),_:1}),e(T,{label:"股票代码"},{default:t(()=>[i(r(d.value.stock_code),1)]),_:1}),e(T,{label:"状态"},{default:t(()=>[e(le,{type:A(d.value.status)},{default:t(()=>[i(r(g(d.value.status)),1)]),_:1},8,["type"])]),_:1}),e(T,{label:"创建时间"},{default:t(()=>[i(r(te(d.value.created_at)),1)]),_:1}),e(T,{label:"完成时间"},{default:t(()=>[i(r(d.value.completed_at?te(d.value.completed_at):"-"),1)]),_:1}),d.value.result_summary?.total_return!==void 0?(p(),L(T,{key:0,label:"总收益率"},{default:t(()=>[l("span",{class:Y(H(d.value.result_summary?.total_return))},r(G(d.value.result_summary?.total_return)),3)]),_:1})):P("",!0),d.value.result_summary?.max_drawdown!==void 0?(p(),L(T,{key:1,label:"最大回撤"},{default:t(()=>[l("span",mt,r(G(d.value.result_summary?.max_drawdown??0)),1)]),_:1})):P("",!0)]),_:1}),l("div",pt,[e(v,{type:"primary",onClick:a[6]||(a[6]=o=>F(d.value.task_id)),disabled:d.value.status!=="created",loading:V.value.has(d.value.task_id)},{default:t(()=>[...a[21]||(a[21]=[i(" 运行任务 ",-1)])]),_:1},8,["disabled","loading"]),e(v,{type:"info",onClick:a[7]||(a[7]=o=>x(d.value.task_id)),loading:N.value.has(d.value.task_id)},{default:t(()=>[...a[22]||(a[22]=[i(" 刷新状态 ",-1)])]),_:1},8,["loading"]),e(v,{type:"success",onClick:a[8]||(a[8]=o=>j(d.value.task_id)),disabled:d.value.status!=="completed"},{default:t(()=>[...a[23]||(a[23]=[i(" 查看结果 ",-1)])]),_:1},8,["disabled"])])])):P("",!0)]),_:1},8,["modelValue"]),e(Ze,{visible:C.value,"onUpdate:visible":a[11]||(a[11]=o=>C.value=o),"task-id":S.value},null,8,["visible","task-id"])])}}}),kt=ie(vt,[["__scopeId","data-v-897a121f"]]);export{kt as default};
