import{f as Y,g as L,S as Se,b as Me,c as xe}from"./stockHistoryApi-BqpgZ5S8.js";import{g as Te,c as Ye,r as Pe,a as Be,b as Le}from"./quantBacktestApi-CjQsoYmC.js";import{g as ae}from"./individualStockApi-DfFs6no1.js";import{i as Ne,L as $e}from"./index-ElshY9iF.js";import{d as Ue,r as O,a as g,x as Fe,z as Re,A as Ie,c as D,b as d,g as h,e as a,w as l,i as f,E as _,f as C,F as Q,y as j,k as p,t as i,o as m,_ as ze}from"./index-DZgUmUth.js";const qe={class:"quantitative-backtest-view"},Ae={class:"control-panel"},Ee={key:0,class:"chart-container"},Ke={class:"card-header"},He={class:"stock-info"},Oe={key:1,class:"empty-state"},Qe={key:2,class:"strategy-panel"},je={key:3,class:"result-container"},Ge={class:"card-header"},Je={key:0,class:"trades-table"},We={class:"performance-metrics"},Xe={key:0,class:"result-chart"},Ze=Ue({__name:"QuantitativeBacktestView",setup(et){const r=O({stockCode:"",stockName:"",dateRangeType:"month",startDate:"",endDate:""}),u=O({strategyName:"",initialCash:1e6,strategyParams:{}}),S=g([]),c=O({code:"",name:"",industry:"",listDate:"",totalMarketCap:0,circulatingMarketCap:0}),F=g([]),le=g(""),A=g(!1),E=g([]),P=g(null),b=g(""),M=g(""),n=g(null),N=g([]),K=g(null),w=g(!1),se=Fe(()=>!!r.stockCode&&!!u.strategyName&&S.value.length>0),oe=((e,t)=>{let s;return(...v)=>{clearTimeout(s),s=setTimeout(()=>e.apply(null,v),t)}})(async(e="")=>{try{A.value=!0;const t={page:1,page_size:50,keyword:e.trim()},s=await ae(t);F.value=s.data}catch(t){console.error("搜索股票列表失败:",t)}finally{A.value=!1}},300),re=e=>{le.value=e,(e.length>=1||e.length===0)&&oe(e)},ne=e=>{const t=F.value.find(s=>s.code===e);t&&(r.stockCode=t.code,r.stockName=t.name,ue(t.code))},ue=async e=>{try{const t=await Me(e);c.code=t.code,c.name=t.name,c.industry=t.industry,c.listDate=t.list_date,c.totalMarketCap=t.total_market_cap,c.circulatingMarketCap=t.circulating_market_cap}catch(t){console.error("获取股票详细信息失败:",t),_.error("获取股票详细信息失败")}},G=()=>{const t=Y(new Date);switch(r.endDate=t,r.dateRangeType){case"week":r.startDate=Y(L(7));break;case"month":r.startDate=Y(L(30));break;case"threeMonths":r.startDate=Y(L(90));break;case"sixMonths":r.startDate=Y(L(180));break;case"year":r.startDate=Y(L(365));break;case"threeYears":r.startDate=Y(L(365*3));break;case"all":r.startDate="";break}},de=async()=>{if(!r.stockCode){_.warning("请先选择股票");return}if(r.dateRangeType==="custom"&&(!r.startDate||!r.endDate)){_.warning("请选择完整的日期范围");return}w.value=!0;try{let e=r.startDate,t=r.endDate;e&&(e=e.replace(/-/g,"")),t&&(t=t.replace(/-/g,""));const s=await xe(r.stockCode,e,t);S.value=s,s.length>0?_.success("股票数据获取成功"):_.warning("未查询到股票历史数据"),J()}catch(e){console.error("获取股票数据失败:",e),_.error("获取股票数据失败"),S.value=[]}finally{w.value=!1}},ce=()=>{r.stockCode="",r.stockName="",r.dateRangeType="month",r.startDate="",r.endDate="",S.value=[],c.code="",c.name="",c.industry="",c.listDate="",c.totalMarketCap=0,c.circulatingMarketCap=0,J()},J=()=>{u.strategyName="",u.strategyParams={},P.value=null,b.value="",M.value="",n.value=null,N.value=[]},ie=()=>{u.strategyName="",u.initialCash=1e6,u.strategyParams={},P.value=null,b.value="",M.value="",n.value=null,N.value=[]},W=e=>e?e>=1e8?`${(e/1e8).toFixed(2)}亿`:e>=1e4?`${(e/1e4).toFixed(2)}万`:e.toString():"未知",R=e=>e==null?"-":`${e.toFixed(2)}%`,I=e=>e?e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",me=e=>{switch(e){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},pe=e=>{switch(e){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},fe=async()=>{try{w.value=!0;const e=await ae({page:1,page_size:100});F.value=e.data}catch(e){console.error("加载股票列表失败:",e),_.error("加载股票列表失败")}finally{w.value=!1}},_e=async()=>{try{w.value=!0;const e=await Te();E.value=e}catch(e){console.error("加载策略列表失败:",e),_.error("加载策略列表失败")}finally{w.value=!1}},ve=e=>{const t=E.value.find(s=>s.name===e);t&&(P.value=t,console.log("选择策略:",t),u.strategyParams={},t.params&&Object.keys(t.params).forEach(s=>{u.strategyParams[s]=t.params[s].default}))},ye=async()=>{if(!r.stockCode||!u.strategyName){_.warning("请选择股票和策略");return}w.value=!0;try{const e=v=>v?v.includes("-")?v:v.length===8?`${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`:v:"",t={strategy_name:u.strategyName,stock_code:r.stockCode,start_date:e(r.startDate),end_date:e(r.endDate),initial_cash:u.initialCash,strategy_params:u.strategyParams},s=await Ye(t);b.value=s.task_id,M.value=s.status,_.success("回测任务创建成功")}catch(e){console.error("创建回测任务失败:",e),_.error("创建回测任务失败")}finally{w.value=!1}},ge=async()=>{if(!b.value){_.warning("请先创建回测任务");return}w.value=!0;try{const e=await Pe(b.value);M.value=e.status,_.success("回测任务已启动"),X()}catch(e){console.error("启动回测任务失败:",e),_.error("启动回测任务失败")}finally{w.value=!1}},X=async()=>{if(b.value)try{const e=await Be(b.value);M.value=e.status,e.status==="completed"?ke():e.status==="failed"?_.error("回测任务执行失败"):e.status==="running"&&setTimeout(X,2e3)}catch(e){console.error("获取任务状态失败:",e),_.error("获取任务状态失败")}},ke=async()=>{if(b.value)try{const e=await Le(b.value);n.value=e,he(),Z()}catch(e){console.error("获取回测结果失败:",e),_.error("获取回测结果失败")}},he=()=>{if(!n.value)return;const e=[];if(n.value.detailed_data?.trade_records){const t=n.value.detailed_data.trade_records;for(const s of t)e.push({date:s.datetime.split("T")[0],price:s.price,type:s.type,description:`${s.type==="buy"?"买入":"卖出"} ${Math.abs(s.size)}股`})}else if(n.value.trades){const t=n.value.trades;for(const s of t)e.push({date:s.date,price:s.price,type:s.action,description:`${s.action==="buy"?"买入":"卖出"} ${Math.abs(s.quantity)}股`})}N.value=e,console.log("交易点数据已更新:",N.value.length,"个交易点")},Z=()=>{if(!K.value||!n.value)return;const e=n.value.detailed_data?.portfolio_values||n.value.portfolio_value;if(!e||e.length===0)return;const t=Ne(K.value),s=e.map(y=>y.date),v=e.map(y=>y.value),k={title:{text:"投资组合价值变化",left:"center"},tooltip:{trigger:"axis",formatter:y=>{const $=y[0].axisValue,z=y[0].data;return`${$}<br/>组合价值: ${I(z)}`}},xAxis:{type:"category",data:s},yAxis:{type:"value",name:"组合价值",axisLabel:{formatter:y=>I(y)}},series:[{name:"组合价值",type:"line",data:v,smooth:!0,lineStyle:{width:2,color:"#5470c6"},areaStyle:{color:new $e(0,0,0,1,[{offset:0,color:"rgba(84, 112, 198, 0.5)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}])}}]};t.setOption(k),window.addEventListener("resize",()=>{t.resize()})};return Re(()=>n.value,()=>{setTimeout(()=>{Z()},0)}),Ie(()=>{G(),fe(),_e()}),(e,t)=>{const s=f("el-option"),v=f("el-select"),k=f("el-form-item"),y=f("el-col"),$=f("el-row"),z=f("el-date-picker"),U=f("el-button"),ee=f("el-form"),q=f("el-card"),be=f("el-empty"),H=f("el-input-number"),we=f("el-input"),De=f("el-switch"),te=f("el-tag"),B=f("el-table-column"),Ce=f("el-table"),x=f("el-descriptions-item"),Ve=f("el-descriptions");return m(),D("div",qe,[t[16]||(t[16]=d("div",{class:"page-header"},[d("h1",null,"量化策略回测"),d("p",null,"选择股票和策略，进行量化回测分析")],-1)),d("div",Ae,[a(q,null,{header:l(()=>[...t[6]||(t[6]=[d("div",{class:"card-header"},[d("span",null,"股票选择")],-1)])]),default:l(()=>[a(ee,{model:r,"label-width":"100px",class:"query-form"},{default:l(()=>[a($,{gutter:20},{default:l(()=>[a(y,{span:8},{default:l(()=>[a(k,{label:"股票代码"},{default:l(()=>[a(v,{modelValue:r.stockCode,"onUpdate:modelValue":t[0]||(t[0]=o=>r.stockCode=o),placeholder:"请选择或输入股票代码",class:"full-width",onChange:ne,filterable:"",remote:"","remote-method":re,loading:A.value,"allow-create":"","default-first-option":"","reserve-keyword":!1},{default:l(()=>[(m(!0),D(Q,null,j(F.value,o=>(m(),C(s,{key:o.code,label:`${o.code} ${o.name}`,value:o.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1})]),_:1}),a(y,{span:8},{default:l(()=>[a(k,{label:"时间范围"},{default:l(()=>[a(v,{modelValue:r.dateRangeType,"onUpdate:modelValue":t[1]||(t[1]=o=>r.dateRangeType=o),onChange:G,class:"full-width"},{default:l(()=>[a(s,{label:"最近一周",value:"week"}),a(s,{label:"最近一月",value:"month"}),a(s,{label:"最近三月",value:"threeMonths"}),a(s,{label:"最近六月",value:"sixMonths"}),a(s,{label:"最近一年",value:"year"}),a(s,{label:"最近三年",value:"threeYears"}),a(s,{label:"全部",value:"all"}),a(s,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),r.dateRangeType==="custom"?(m(),C($,{key:0,gutter:20},{default:l(()=>[a(y,{span:8},{default:l(()=>[a(k,{label:"开始日期"},{default:l(()=>[a(z,{modelValue:r.startDate,"onUpdate:modelValue":t[2]||(t[2]=o=>r.startDate=o),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1}),a(y,{span:8},{default:l(()=>[a(k,{label:"结束日期"},{default:l(()=>[a(z,{modelValue:r.endDate,"onUpdate:modelValue":t[3]||(t[3]=o=>r.endDate=o),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})):h("",!0),a(k,null,{default:l(()=>[a(U,{type:"primary",onClick:de},{default:l(()=>[...t[7]||(t[7]=[p("查询",-1)])]),_:1}),a(U,{onClick:ce},{default:l(()=>[...t[8]||(t[8]=[p("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),S.value.length>0?(m(),D("div",Ee,[a(q,null,{header:l(()=>[d("div",Ke,[d("span",null,i(c.name)+"("+i(c.code)+") K线图",1),d("div",He,[d("span",null,"行业: "+i(c.industry||"未知"),1),d("span",null,"上市日期: "+i(c.listDate||"未知"),1),d("span",null,"总市值: "+i(W(c.totalMarketCap)),1),d("span",null,"流通市值: "+i(W(c.circulatingMarketCap)),1)])])]),default:l(()=>[a(Se,{"stock-code":c.code,"stock-name":c.name,"kline-data":S.value,"trade-signals":N.value,height:"500px","show-volume":!0},null,8,["stock-code","stock-name","kline-data","trade-signals"])]),_:1})])):h("",!0),S.value.length===0?(m(),D("div",Oe,[a(be,{description:"请选择股票并查询数据"})])):h("",!0),S.value.length>0?(m(),D("div",Qe,[a(q,null,{header:l(()=>[...t[9]||(t[9]=[d("div",{class:"card-header"},[d("span",null,"策略配置")],-1)])]),default:l(()=>[a(ee,{model:u,"label-width":"120px",class:"strategy-form"},{default:l(()=>[a(k,{label:"选择策略"},{default:l(()=>[a(v,{modelValue:u.strategyName,"onUpdate:modelValue":t[4]||(t[4]=o=>u.strategyName=o),placeholder:"请选择策略",class:"full-width",onChange:ve},{default:l(()=>[(m(!0),D(Q,null,j(E.value,o=>(m(),C(s,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(k,{label:"初始资金"},{default:l(()=>[a(H,{modelValue:u.initialCash,"onUpdate:modelValue":t[5]||(t[5]=o=>u.initialCash=o),min:1e4,step:1e4,precision:0,class:"full-width"},null,8,["modelValue"])]),_:1}),P.value&&P.value.params?(m(!0),D(Q,{key:0},j(P.value.params,(o,V)=>(m(),C(k,{key:V,label:o.description},{default:l(()=>[o.type==="int"?(m(),C(H,{key:0,modelValue:u.strategyParams[V],"onUpdate:modelValue":T=>u.strategyParams[V]=T,min:1,precision:0,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):o.type==="string"?(m(),C(we,{key:1,modelValue:u.strategyParams[V],"onUpdate:modelValue":T=>u.strategyParams[V]=T,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):o.type==="float"?(m(),C(H,{key:2,modelValue:u.strategyParams[V],"onUpdate:modelValue":T=>u.strategyParams[V]=T,precision:2,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):o.type==="boolean"?(m(),C(De,{key:3,modelValue:u.strategyParams[V],"onUpdate:modelValue":T=>u.strategyParams[V]=T},null,8,["modelValue","onUpdate:modelValue"])):h("",!0)]),_:2},1032,["label"]))),128)):h("",!0),a(k,null,{default:l(()=>[a(U,{type:"primary",onClick:ye,disabled:!se.value},{default:l(()=>[...t[10]||(t[10]=[p("创建回测任务",-1)])]),_:1},8,["disabled"]),a(U,{type:"success",onClick:ge,disabled:!b.value},{default:l(()=>[...t[11]||(t[11]=[p("运行回测",-1)])]),_:1},8,["disabled"]),a(U,{onClick:ie},{default:l(()=>[...t[12]||(t[12]=[p("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])):h("",!0),n.value?(m(),D("div",je,[a(q,null,{header:l(()=>[d("div",Ge,[t[13]||(t[13]=d("span",null,"回测结果",-1)),M.value?(m(),C(te,{key:0,type:me(M.value)},{default:l(()=>[p(i(pe(M.value)),1)]),_:1},8,["type"])):h("",!0)])]),default:l(()=>[a($,{gutter:20},{default:l(()=>[a(y,{span:16},{default:l(()=>[n.value.detailed_data?.trade_records&&n.value.detailed_data.trade_records.length>0||n.value.trades&&n.value.trades.length>0?(m(),D("div",Je,[t[14]||(t[14]=d("h3",null,"交易记录",-1)),a(Ce,{data:n.value.detailed_data?.trade_records||n.value.trades,stripe:"",style:{width:"100%"}},{default:l(()=>[a(B,{label:"日期",width:"180"},{default:l(o=>[p(i(o.row.datetime||o.row.date),1)]),_:1}),a(B,{label:"操作",width:"80"},{default:l(o=>[a(te,{type:(o.row.type||o.row.action)==="buy"?"danger":"success"},{default:l(()=>[p(i((o.row.type||o.row.action)==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),a(B,{prop:"price",label:"价格",width:"100"}),a(B,{label:"数量",width:"100"},{default:l(o=>[p(i(Math.abs(o.row.size||o.row.quantity)),1)]),_:1}),a(B,{label:"金额",width:"120"},{default:l(o=>[p(i(I(o.row.value||o.row.amount)),1)]),_:1}),n.value.detailed_data?.trade_records?(m(),C(B,{key:0,label:"手续费",width:"100"},{default:l(o=>[p(i(I(o.row.commission)),1)]),_:1})):h("",!0)]),_:1},8,["data"])])):h("",!0)]),_:1}),a(y,{span:8},{default:l(()=>[d("div",We,[t[15]||(t[15]=d("h3",null,"绩效指标",-1)),a(Ve,{column:1,border:""},{default:l(()=>[a(x,{label:"总收益率"},{default:l(()=>[p(i(R(n.value.performance?.total_return)),1)]),_:1}),a(x,{label:"年化收益率"},{default:l(()=>[p(i(R(n.value.performance?.annual_return)),1)]),_:1}),a(x,{label:"最大回撤"},{default:l(()=>[p(i(R(n.value.performance?.max_drawdown)),1)]),_:1}),a(x,{label:"夏普比率"},{default:l(()=>[p(i(n.value.performance?.sharpe_ratio?.toFixed(2)||"-"),1)]),_:1}),a(x,{label:"胜率"},{default:l(()=>[p(i(R(n.value.performance?.win_rate)),1)]),_:1}),a(x,{label:"交易次数"},{default:l(()=>[p(i(n.value.performance?.total_trades),1)]),_:1}),a(x,{label:"盈利交易"},{default:l(()=>[p(i(n.value.performance?.winning_trades),1)]),_:1}),a(x,{label:"亏损交易"},{default:l(()=>[p(i(n.value.performance?.losing_trades),1)]),_:1})]),_:1})])]),_:1})]),_:1}),n.value.detailed_data?.portfolio_values&&n.value.detailed_data.portfolio_values.length>0||n.value.portfolio_value&&n.value.portfolio_value.length>0?(m(),D("div",Xe,[d("div",{ref_key:"portfolioChartRef",ref:K,style:{height:"300px"}},null,512)])):h("",!0)]),_:1})])):h("",!0)])}}}),ut=ze(Ze,[["__scopeId","data-v-389db3bf"]]);export{ut as default};
