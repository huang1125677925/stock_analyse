import{i as fe}from"./index-1yOyFXf9.js";import{x as ee,d as me,a as w,D as H,y as pe,W as ve,J as z,G as ge,c as W,e as _,w as S,i as A,E as O,b as $,f as F,g as P,k as M,F as J,A as X,l as q,K as he,o as E,_ as _e}from"./index-CMCs1k_N.js";import{F as xe,f as ye,a as Y}from"./industry-fund-flow-Hap3LZ-B.js";const we="/django/api/strategy";async function be(p,x){try{return(await ee.get(`${we}/industry-turnover-percentile/`,{params:{start_date:p,end_date:x}})).data}catch(r){throw console.error("获取行业换手率分位数数据失败:",r),r}}const Se="/django/api/stock";async function Ce(p,x,r,I){try{const h={};return p&&(h.industry=p),x&&(h.report_type=x),(await ee.get(`${Se}/industry/heatmap-data/`,{params:h})).data}catch(h){throw console.error("获取行业热力图数据失败:",h),h}}var te=(p=>(p.OPERATING_REVENUE_GROWTH="avg_operating_revenue_growth_rate",p.NET_PROFIT_GROWTH="avg_net_profit_growth_rate",p.TOTAL_OPERATING_REVENUE="total_operating_revenue",p.TOTAL_NET_PROFIT="total_net_profit",p.EARNINGS_PER_SHARE="avg_earnings_per_share",p.ROE="avg_roe",p.GROSS_PROFIT_MARGIN="avg_gross_profit_margin",p.NET_ASSETS_PER_SHARE="avg_net_assets_per_share",p.OPERATING_CASH_FLOW_PER_SHARE="avg_operating_cash_flow_per_share",p))(te||{});const Z={avg_operating_revenue_growth_rate:{name:"营业收入增长率",unit:"%",description:"平均营业收入增长率"},avg_net_profit_growth_rate:{name:"净利润增长率",unit:"%",description:"平均净利润增长率"},total_operating_revenue:{name:"总营业收入",unit:"亿元",description:"总营业收入",formatter:p=>(p/1e8).toFixed(2)},total_net_profit:{name:"总净利润",unit:"亿元",description:"总净利润",formatter:p=>(p/1e8).toFixed(2)},avg_earnings_per_share:{name:"每股收益",unit:"元",description:"平均每股收益"},avg_roe:{name:"净资产收益率",unit:"%",description:"平均净资产收益率"},avg_gross_profit_margin:{name:"毛利率",unit:"%",description:"平均毛利率"},avg_net_assets_per_share:{name:"每股净资产",unit:"元",description:"平均每股净资产"},avg_operating_cash_flow_per_share:{name:"每股经营现金流",unit:"元",description:"平均每股经营现金流"}},Ie={class:"congestion-heatmap"},Le={class:"header-controls"},Ee={class:"controls"},Ae=me({__name:"CongestionHeatmap",setup(p){const x=w();let r=null;const I=w("amount"),h=w("20"),T=w(!0),L=w(""),j=w(!1),y=w("turnover"),N=w(te.OPERATING_REVENUE_GROWTH),D=w(xe.MAIN_NET_INFLOW_AMOUNT),R=w("annual"),k=w([]),U=w([]),B=w(null),V=w(null),G=async()=>{j.value=!0;try{y.value==="turnover"?await ae():y.value==="performance"?await ne():y.value==="fundflow"&&await oe()}catch(t){console.error("获取数据出错:",t),O.error("获取数据出错，请检查网络连接或API服务是否可用")}finally{j.value=!1}},ae=async()=>{const t=new Date,a=t.toISOString().split("T")[0],d=h.value==="all"?30:parseInt(h.value),c=new Date(t);c.setDate(t.getDate()-d);const l=c.toISOString().split("T")[0],s=await be(l,a);if(s){const n=s.data;if(!Array.isArray(n))throw console.error("API返回的数据不是数组:",n),new Error("API返回的数据格式不正确");const i=[...new Set(n.map(f=>f.date))].sort();U.value=i;const o=new Map;n.forEach(f=>{o.has(f.sector_code)||o.set(f.sector_code,{name:f.sector_name,data:[]});const e=o.get(f.sector_code),u=i.indexOf(f.date);for(;e.data.length<i.length;)e.data.push({turnoverRateFQuantile:0,amountCongestionQuantile:0});e.data[u]={turnoverRateFQuantile:f.turnover_ratio_percentile,amountCongestionQuantile:f.turnover_ratio_percentile}}),k.value=Array.from(o.values())}else O.error("获取数据失败: ")},ne=async()=>{const t=await Ce(L.value.trim()||void 0,R.value,void 0,void 0);t?B.value=t:O.error("获取行业业绩数据失败")},oe=async()=>{const t=new Date,a=t.toISOString().split("T")[0],d=h.value==="all"?30:parseInt(h.value),c=new Date(t);c.setDate(t.getDate()-d);const l=c.toISOString().split("T")[0],s=await ye(l,a);s?V.value=s:O.error("获取行业资金流数据失败")},re=()=>{let t=k.value;L.value.trim()&&(t=k.value.filter(c=>c.name.toLowerCase().includes(L.value.toLowerCase())));const a=h.value==="all"?U.value:U.value.slice(-parseInt(h.value)),d=t.map(c=>({...c,data:h.value==="all"?c.data:c.data.slice(-parseInt(h.value))}));return{dates:a,industries:d}},se=()=>{x.value&&(r=fe(x.value),C())},C=()=>{if(r)if(y.value==="turnover"){const{dates:t,industries:a}=re();L.value.trim()?de(a,t):ue(a,t)}else y.value==="performance"?ie():y.value==="fundflow"&&le()},ie=()=>{if(!r||!B.value)return;const t=B.value,a=t.dates,d=t.swCodeNames;let c=d;L.value.trim()&&(c=d.filter(e=>e.indexName.toLowerCase().includes(L.value.toLowerCase())));const l=[...c].sort((e,u)=>{const v=t.congestions[e.indexCode]||t.congestions[e.indexName],g=t.congestions[u.indexCode]||t.congestions[u.indexName];if(!v||!g||v.length===0||g.length===0)return 0;const b=v[v.length-1][N.value],m=g[g.length-1][N.value];return T.value?b-m:m-b}),s=[];let n=1/0,i=-1/0;l.forEach((e,u)=>{const v=t.congestions[e.indexCode]||t.congestions[e.indexName];v&&v.forEach((g,b)=>{const m=g[N.value];typeof m=="number"&&!isNaN(m)&&isFinite(m)&&(s.push([b,u,m]),n=Math.min(n,m),i=Math.max(i,m))})}),(n===1/0||i===-1/0)&&(n=0,i=100);const o=Z[N.value];r.clear();const f={tooltip:{position:"top",formatter:function(e){const[u,v,g]=e.data,b=a[u],m=l[v].indexName,Q=o.formatter?o.formatter(g):g.toFixed(2);return`${m}<br/>${b}<br/>${o.name}: ${Q}${o.unit}`}},grid:{height:Math.max(400,l.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:a,splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:a,axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"报告期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:l.map(e=>e.indexName),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:l.map(e=>e.indexName),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:n,max:i,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:o.name,type:"heatmap",data:s,label:{show:!0,fontSize:9,formatter:function(e){const u=e.data[2];return o.formatter?o.formatter(u):u.toFixed(1)}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};z(()=>{if(r&&(r.setOption(f),x.value)){const e=Math.max(500,l.length*22+120);x.value.style.height=e+"px",setTimeout(()=>{r&&r.resize()},0)}})},le=()=>{if(console.log(V.value),!r||!V.value)return;const t=V.value,a=t.dates,d=t.swCodeNames;let c=d;L.value.trim()&&(c=d.filter(e=>e.indexName.toLowerCase().includes(L.value.toLowerCase())));const l=[...c].sort((e,u)=>{const v=t.congestions[e.indexCode]||t.congestions[e.indexName],g=t.congestions[u.indexCode]||t.congestions[u.indexName];if(!v||!g||v.length===0||g.length===0)return 0;const b=v[v.length-1][D.value],m=g[g.length-1][D.value];return T.value?b-m:m-b}),s=[];let n=1/0,i=-1/0;l.forEach((e,u)=>{const v=t.congestions[e.indexCode]||t.congestions[e.indexName];v&&v.forEach((g,b)=>{const m=g[D.value];typeof m=="number"&&!isNaN(m)&&isFinite(m)&&(s.push([b,u,m]),n=Math.min(n,m),i=Math.max(i,m))})}),(n===1/0||i===-1/0)&&(n=0,i=100);const o=Y[D.value];r.clear();const f={tooltip:{position:"top",formatter:function(e){const[u,v,g]=e.data,b=a[u],m=l[v].indexName,Q=o.formatter?o.formatter(g):g.toFixed(2);return`${m}<br/>${b}<br/>${o.name}: ${Q}${o.unit}`}},grid:{height:Math.max(400,l.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:a,splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:a,axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:l.map(e=>e.indexName),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:l.map(e=>e.indexName),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:n,max:i,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:o.name,type:"heatmap",data:s,label:{show:!0,fontSize:9,formatter:function(e){const u=e.data[2];return o.formatter?o.formatter(u):u.toFixed(1)}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};z(()=>{if(r&&(r.setOption(f),x.value)){const e=Math.max(500,l.length*22+120);x.value.style.height=e+"px",setTimeout(()=>{r&&r.resize()},0)}})},ue=(t,a)=>{if(!r)return;const d=[...t].sort((s,n)=>{if(s.data.length===0||n.data.length===0)return 0;const i=s.data[s.data.length-1][I.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"],o=n.data[n.data.length-1][I.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"];return T.value?i-o:o-i}),c=[];d.forEach((s,n)=>{s.data.forEach((i,o)=>{const f=I.value==="turnover"?i.turnoverRateFQuantile:i.amountCongestionQuantile;typeof f=="number"&&!isNaN(f)&&isFinite(f)&&c.push([o,n,f])})}),r.clear(),r.clear();const l={tooltip:{position:"top",formatter:function(s){const[n,i,o]=s.data,f=a[n],e=d[i].name,u=I.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";return`${e}<br/>${f}<br/>${u}: ${o}`}},grid:{height:Math.max(400,d.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:a.map(s=>s.substring(5)),splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:a.map(s=>s.substring(5)),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:d.map(s=>s.name),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:d.map(s=>s.name),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:0,max:100,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:I.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",type:"heatmap",data:c,label:{show:!0,fontSize:9,formatter:function(s){return s.data[2]}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};if(r.setOption(l),x.value){const s=Math.max(500,d.length*22+120);x.value.style.height=s+"px",r.resize()}},de=(t,a)=>{if(!r)return;const d=["#5470C6","#91CC75","#EE6666","#FAC858","#73C0DE","#3BA272","#FC8452","#9A60B4","#EA7CCC","#2f4554","#61a0a8","#d48265","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],c=n=>{let i=0;for(let o=0;o<n.length;o++)i=i*31+n.charCodeAt(o)>>>0;return d[i%d.length]},l=t.map(n=>{const i=c(n.name);return{name:n.name,type:"line",data:n.data.map(o=>I.value==="turnover"?o.turnoverRateFQuantile:o.amountCongestionQuantile),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:i},itemStyle:{color:i}}});r.clear();const s={title:{text:`行业拥挤度趋势图 - ${t.map(n=>n.name).join("、")}`,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:function(n){let i=`${n[0].axisValue}<br/>`;return n.forEach(o=>{const f=I.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";i+=`${o.seriesName} ${f}: ${o.value}<br/>`}),i}},legend:{type:"scroll",data:t.map(n=>n.name),top:"5%"},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:a.map(n=>n.substring(5)),axisLabel:{rotate:45}},yAxis:{type:"value",name:I.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",min:0,max:100},series:l};z(()=>{r&&(r.setOption(s,!0),x.value&&(x.value.style.height="500px",setTimeout(()=>{r&&r.resize()},0)))})},ce=()=>{T.value=!T.value,C()},K=()=>{r&&r.resize()};return H([I,L],()=>{r&&C()}),H([y,N,R],async()=>{await G(),r&&C()}),H(h,async()=>{(y.value==="turnover"||y.value==="fundflow")&&(await G(),r&&C())}),pe(async()=>{const t=ve.service({target:".congestion-heatmap",text:"加载数据中...",background:"rgba(255, 255, 255, 0.7)"});try{await G(),await z(),se()}finally{t.close()}window.addEventListener("resize",K)}),ge(()=>{r&&r.dispose(),window.removeEventListener("resize",K)}),(t,a)=>{const d=A("el-radio-button"),c=A("el-radio-group"),l=A("el-option"),s=A("el-select"),n=A("el-icon"),i=A("el-input"),o=A("el-button"),f=A("el-card");return E(),W("div",Ie,[_(f,null,{header:S(()=>[$("div",Le,[a[10]||(a[10]=$("h3",null,"行业拥挤度热力图",-1)),$("div",Ee,[_(c,{modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=e=>y.value=e),onChange:C,size:"small"},{default:S(()=>[_(d,{label:"turnover"},{default:S(()=>[...a[6]||(a[6]=[M("成交金额占比分位数",-1)])]),_:1}),_(d,{label:"performance"},{default:S(()=>[...a[7]||(a[7]=[M("行业业绩指标",-1)])]),_:1}),_(d,{label:"fundflow"},{default:S(()=>[...a[8]||(a[8]=[M("行业资金流",-1)])]),_:1})]),_:1},8,["modelValue"]),y.value==="performance"?(E(),F(s,{key:0,modelValue:N.value,"onUpdate:modelValue":a[1]||(a[1]=e=>N.value=e),onChange:C,placeholder:"选择指标",style:{width:"180px","margin-left":"10px"}},{default:S(()=>[(E(!0),W(J,null,X(q(Z),(e,u)=>(E(),F(l,{key:u,label:e.name,value:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):P("",!0),y.value==="performance"?(E(),F(s,{key:1,modelValue:R.value,"onUpdate:modelValue":a[2]||(a[2]=e=>R.value=e),onChange:C,placeholder:"选择报告类型",style:{width:"120px","margin-left":"10px"}},{default:S(()=>[_(l,{label:"年报",value:"annual"}),_(l,{label:"中报",value:"semi_annual"}),_(l,{label:"一季报",value:"q1"}),_(l,{label:"三季报",value:"q3"}),_(l,{label:"季报",value:"quarterly"})]),_:1},8,["modelValue"])):P("",!0),y.value==="fundflow"?(E(),F(s,{key:2,modelValue:D.value,"onUpdate:modelValue":a[3]||(a[3]=e=>D.value=e),onChange:C,placeholder:"选择资金流指标",style:{width:"180px","margin-left":"10px"}},{default:S(()=>[(E(!0),W(J,null,X(q(Y),(e,u)=>(E(),F(l,{key:u,label:e.name,value:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):P("",!0),y.value==="turnover"||y.value==="fundflow"?(E(),F(s,{key:3,modelValue:h.value,"onUpdate:modelValue":a[4]||(a[4]=e=>h.value=e),onChange:C,placeholder:"选择日期范围",style:{width:"150px","margin-left":"10px"}},{default:S(()=>[_(l,{label:"最近10天",value:"10"}),_(l,{label:"最近15天",value:"15"}),_(l,{label:"最近20天",value:"20"}),_(l,{label:"全部29天",value:"all"})]),_:1},8,["modelValue"])):P("",!0),_(i,{modelValue:L.value,"onUpdate:modelValue":a[5]||(a[5]=e=>L.value=e),onInput:C,onClear:C,placeholder:"搜索行业",style:{width:"200px","margin-left":"10px"},clearable:""},{prefix:S(()=>[_(n,null,{default:S(()=>[_(q(he))]),_:1})]),_:1},8,["modelValue"]),_(o,{onClick:ce,type:"primary"},{default:S(()=>[...a[9]||(a[9]=[M("按最后一列排序",-1)])]),_:1})])])]),default:S(()=>[$("div",{ref_key:"chartContainer",ref:x,class:"chart-container"},null,512)]),_:1})])}}}),Fe=_e(Ae,[["__scopeId","data-v-d1c3a6ac"]]);export{Fe as default};
