import{d as re,r as ne,a as k,z as T,y as ue,j as de,c as y,b as c,g as V,e as t,w as r,i,E as g,F as w,A as D,k as U,t as N,P as ce,u as ie,o as d,f as S,_ as me}from"./index-Cmt4OYPI.js";import{g as pe,c as fe,r as ye}from"./quantBacktestApi-Cd5p1Bne.js";import{g as O}from"./individualStockApi-DdaU6AyX.js";import{g as R}from"./etfApi-r4yH_2Fh.js";const _e={class:"backtest-strategy-view"},ge={class:"strategy-config-panel"},ve={key:0,class:"strategy-params"},be={key:0,class:"strategy-description"},he={class:"description-content"},Se={key:0,class:"params-info"},ke=2,Ve=re({__name:"BacktestStrategyCreate",setup(we){const j=ie(),L=de(),e=ne({strategyName:"",symbol:"",stockName:"",startDate:"",endDate:"",frequency:"daily",initialCash:1e6,strategyParams:{},dataSource:"stock"}),C=k([]),_=k([]),p=k(null),P=k(!1),A=k(""),v=k(!1),B=T(()=>!!e.strategyName&&!!e.symbol&&!!e.startDate&&!!e.endDate),H=T(()=>e.dataSource==="etf"?"ETF代码":"股票代码"),Q=T(()=>e.dataSource==="etf"?"请选择ETF代码":"请选择股票代码"),$=async(l="")=>{try{v.value=!0;const a={page:1,page_size:50,keyword:l.trim()},n=await O(a);_.value=n.data}catch(a){console.error("搜索股票列表失败:",a)}finally{v.value=!1}},F=(l,a)=>{let n;return(...f)=>{clearTimeout(n),n=setTimeout(()=>l.apply(null,f),a)}},G=F($,300),J=F(async(l="")=>{try{v.value=!0;const a={page:1,page_size:50,name:l.trim()||void 0},f=(await R(a)).data||[];_.value=f.map(o=>({code:o.ts_code,name:o.extname||o.csname||o.cname||""}))}catch(a){console.error("搜索ETF列表失败:",a)}finally{v.value=!1}},300),K=l=>{const a=(l??"").trim();if(A.value=a,a.length===0){v.value=!1,_.value.length===0&&(e.dataSource==="etf"?q():E());return}a.length>=ke?e.dataSource==="etf"?J(a):G(a):v.value=!1},W=l=>{const a=_.value.find(n=>n.code===l);e.stockName=a&&a.name||""},q=async()=>{try{const a=(await R({page:1,page_size:100})).data||[];_.value=a.map(n=>({code:n.ts_code,name:n.extname||n.csname||n.cname||""}))}catch(l){console.error("加载ETF列表失败:",l),g.error("加载ETF列表失败")}},X=l=>{e.symbol="",_.value=[],l==="etf"?q():E()},M=l=>{const a=C.value.find(n=>n.name===l);a&&(p.value=a,e.strategyParams={},a.params&&Object.keys(a.params).forEach(n=>{e.strategyParams[n]=a.params[n].default}))},Z=async()=>{if(!B.value){g.warning("请填写完整的回测配置");return}P.value=!0;try{const l={strategy_name:e.strategyName,stock_code:e.symbol,stock_name:e.stockName,start_date:e.startDate,end_date:e.endDate,frequency:e.frequency,initial_cash:e.initialCash,strategy_params:e.strategyParams,data_source:e.dataSource},a=await fe(l);g.success("回测任务创建成功"),ce.confirm("回测任务已创建，是否立即运行？","提示",{confirmButtonText:"立即运行",cancelButtonText:"稍后运行",type:"info"}).then(async()=>{await ee(a.task_id),j.push("/backtest-history")}).catch(()=>{})}catch(l){console.error("创建回测任务失败:",l),g.error("创建回测任务失败")}finally{P.value=!1}},ee=async l=>{try{await ye(l),g.success("回测任务已启动")}catch(a){console.error("运行回测任务失败:",a),g.error("运行回测任务失败")}},ae=()=>{e.strategyName="",e.symbol="",e.stockName="",e.startDate="",e.endDate="",e.frequency="daily",e.initialCash=1e6,e.strategyParams={},p.value=null},te=async()=>{try{const l=await pe();C.value=l}catch(l){console.error("加载策略列表失败:",l),g.error("加载策略列表失败")}},E=async()=>{try{const a=await O({page:1,page_size:100});_.value=a.data}catch(l){console.error("加载股票列表失败:",l),g.error("加载股票列表失败")}};return ue(async()=>{await Promise.all([te(),E()]);const l=new Date,a=new Date;a.setFullYear(l.getFullYear()-1),e.endDate=l.toISOString().split("T")[0],e.startDate=a.toISOString().split("T")[0];const n=L.query.strategy;n&&(e.strategyName=n,M(n)),(()=>{const o=L.query;if(o.data_source){const u=String(o.data_source);(u==="stock"||u==="etf")&&(e.dataSource=u)}if(o.symbol&&(e.symbol=String(o.symbol)),o.stock_name&&(e.stockName=String(o.stock_name)),o.start_date&&(e.startDate=String(o.start_date)),o.end_date&&(e.endDate=String(o.end_date)),o.initial_cash!==void 0){const u=Number(o.initial_cash);!Number.isNaN(u)&&u>0&&(e.initialCash=Math.round(u))}if(o.frequency){const u=String(o.frequency);(u==="daily"||u==="weekly")&&(e.frequency=u)}if(o.strategy_params)try{const u=decodeURIComponent(String(o.strategy_params)),b=JSON.parse(u);b&&typeof b=="object"&&(e.strategyParams=b)}catch(u){console.error("解析策略参数失败:",u)}e.dataSource==="etf"&&q()})()}),(l,a)=>{const n=i("el-option"),f=i("el-select"),o=i("el-form-item"),u=i("el-col"),b=i("el-row"),x=i("el-date-picker"),Y=i("el-input-number"),le=i("el-input"),se=i("el-switch"),I=i("el-button"),oe=i("el-form"),z=i("el-card");return d(),y("div",_e,[a[13]||(a[13]=c("div",{class:"page-header"},[c("h1",null,"创建回测任务"),c("p",null,"选择策略并配置参数，创建回测任务")],-1)),c("div",ge,[t(z,null,{header:r(()=>[...a[7]||(a[7]=[c("div",{class:"card-header"},[c("span",null,"策略配置")],-1)])]),default:r(()=>[t(oe,{model:e,"label-width":"120px",class:"strategy-form"},{default:r(()=>[t(b,{gutter:20},{default:r(()=>[t(u,{span:8},{default:r(()=>[t(o,{label:"数据源",required:""},{default:r(()=>[t(f,{modelValue:e.dataSource,"onUpdate:modelValue":a[0]||(a[0]=s=>e.dataSource=s),placeholder:"请选择数据源",class:"full-width",onChange:X},{default:r(()=>[t(n,{label:"股票",value:"stock"}),t(n,{label:"ETF",value:"etf"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:8},{default:r(()=>[t(o,{label:"选择策略",required:""},{default:r(()=>[t(f,{modelValue:e.strategyName,"onUpdate:modelValue":a[1]||(a[1]=s=>e.strategyName=s),placeholder:"请选择策略",class:"full-width",onChange:M},{default:r(()=>[(d(!0),y(w,null,D(C.value,s=>(d(),S(n,{key:s.name,label:s.description,value:s.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:8},{default:r(()=>[t(o,{label:H.value,required:""},{default:r(()=>[t(f,{modelValue:e.symbol,"onUpdate:modelValue":a[2]||(a[2]=s=>e.symbol=s),placeholder:Q.value,filterable:"",remote:"","remote-method":K,loading:v.value,clearable:"",style:{width:"100%"},onChange:W},{default:r(()=>[(d(!0),y(w,null,D(_.value,s=>(d(),S(n,{key:s.code,label:`${s.code} - ${s.name}`,value:s.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","loading"])]),_:1},8,["label"])]),_:1})]),_:1}),t(b,{gutter:20},{default:r(()=>[t(u,{span:6},{default:r(()=>[t(o,{label:"开始日期",required:""},{default:r(()=>[t(x,{modelValue:e.startDate,"onUpdate:modelValue":a[3]||(a[3]=s=>e.startDate=s),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1}),t(u,{span:6},{default:r(()=>[t(o,{label:"结束日期",required:""},{default:r(()=>[t(x,{modelValue:e.endDate,"onUpdate:modelValue":a[4]||(a[4]=s=>e.endDate=s),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1}),t(u,{span:6},{default:r(()=>[t(o,{label:"数据频率"},{default:r(()=>[t(f,{modelValue:e.frequency,"onUpdate:modelValue":a[5]||(a[5]=s=>e.frequency=s),placeholder:"选择数据频率",class:"full-width"},{default:r(()=>[t(n,{label:"日频",value:"daily"}),t(n,{label:"周频",value:"weekly"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:6},{default:r(()=>[t(o,{label:"初始资金"},{default:r(()=>[t(Y,{modelValue:e.initialCash,"onUpdate:modelValue":a[6]||(a[6]=s=>e.initialCash=s),min:1e4,step:1e4,precision:0,class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),p.value&&p.value.params?(d(),y("div",ve,[a[8]||(a[8]=c("h3",null,"策略参数",-1)),t(b,{gutter:20},{default:r(()=>[(d(!0),y(w,null,D(p.value.params,(s,m)=>(d(),S(u,{span:8,key:m},{default:r(()=>[t(o,{label:s.description},{default:r(()=>[s.type==="int"?(d(),S(Y,{key:0,modelValue:e.strategyParams[m],"onUpdate:modelValue":h=>e.strategyParams[m]=h,min:1,precision:0,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):s.type==="string"?(d(),S(le,{key:1,modelValue:e.strategyParams[m],"onUpdate:modelValue":h=>e.strategyParams[m]=h,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):s.type==="float"?(d(),S(Y,{key:2,modelValue:e.strategyParams[m],"onUpdate:modelValue":h=>e.strategyParams[m]=h,precision:2,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):s.type==="boolean"?(d(),S(se,{key:3,modelValue:e.strategyParams[m],"onUpdate:modelValue":h=>e.strategyParams[m]=h},null,8,["modelValue","onUpdate:modelValue"])):V("",!0)]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1})])):V("",!0),t(o,null,{default:r(()=>[t(I,{type:"primary",onClick:Z,loading:P.value,disabled:!B.value},{default:r(()=>[...a[9]||(a[9]=[U(" 创建回测任务 ",-1)])]),_:1},8,["loading","disabled"]),t(I,{onClick:ae},{default:r(()=>[...a[10]||(a[10]=[U("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),p.value?(d(),y("div",be,[t(z,null,{header:r(()=>[...a[11]||(a[11]=[c("div",{class:"card-header"},[c("span",null,"策略说明")],-1)])]),default:r(()=>[c("div",he,[c("h3",null,N(p.value.description),1),p.value.params?(d(),y("div",Se,[a[12]||(a[12]=c("h4",null,"参数说明：",-1)),c("ul",null,[(d(!0),y(w,null,D(p.value.params,(s,m)=>(d(),y("li",{key:m},[c("strong",null,N(s.description),1),U(": "+N(s.type)+"类型，默认值: "+N(s.default),1)]))),128))])])):V("",!0)])]),_:1})])):V("",!0)])}}}),Ee=me(Ve,[["__scopeId","data-v-b9932eb0"]]);export{Ee as default};
