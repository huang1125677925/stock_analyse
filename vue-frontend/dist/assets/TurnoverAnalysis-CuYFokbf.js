import{x as z,d as M,z as L,f as B,o as R,_ as T,a as d,y as F,c as $,b as k,e as A,i as N,w as P,k as V,u as O,E as I}from"./index-hKQdfw1y.js";import{D as H}from"./DateRangeSelector-D8NotjjH.js";import"./index-ElshY9iF.js";import{H as K}from"./HeatmapChart-D9uMxBb8.js";const W="/django/api/strategy";async function q(p,u){try{return(await z.get(`${W}/industry-turnover-percentile/`,{params:{start_date:p,end_date:u}})).data}catch(a){throw console.error("获取行业换手率分位数数据失败:",a),a}}const G=M({__name:"TurnoverHeatmap",props:{industries:{},dates:{},searchKeyword:{default:""},sortMetric:{default:"amount"},sortAscending:{type:Boolean,default:!1}},emits:["chart-ready","chart-click"],setup(p,{emit:u}){const a=p,y=u,l=L(()=>{let o=a.industries;return a.searchKeyword?.trim()&&(o=a.industries.filter(s=>s.name.toLowerCase().includes(a.searchKeyword.toLowerCase()))),[...o].sort((s,n)=>{if(s.data.length===0||n.data.length===0)return 0;const i=s.data[s.data.length-1][a.sortMetric==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"],r=n.data[n.data.length-1][a.sortMetric==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"];return a.sortAscending?i-r:r-i})}),m=L(()=>a.searchKeyword?.trim()?h():f()),f=()=>{const o=[];l.value.forEach((n,i)=>{n.data.forEach((r,e)=>{const t=a.sortMetric==="turnover"?r.turnoverRateFQuantile:r.amountCongestionQuantile;typeof t=="number"&&!isNaN(t)&&isFinite(t)&&o.push([e,i,t])})});const s=a.sortMetric==="turnover"?"等权换手率分位数":"成交金额占比分位数";return{tooltip:{position:"top",formatter:function(n){const[i,r,e]=n.data,t=a.dates[i];return`${l.value[r].name}<br/>${t}<br/>${s}: ${e}`}},grid:{height:Math.max(400,l.value.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:a.dates.map(n=>n.substring(5)),splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:a.dates.map(n=>n.substring(5)),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:l.value.map(n=>n.name),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:l.value.map(n=>n.name),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:0,max:100,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:s,type:"heatmap",data:o,label:{show:!0,fontSize:9,formatter:function(n){return n.data[2]}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}},h=()=>{const o=["#5470C6","#91CC75","#EE6666","#FAC858","#73C0DE","#3BA272","#FC8452","#9A60B4","#EA7CCC","#2f4554","#61a0a8","#d48265","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],s=r=>{let e=0;for(let t=0;t<r.length;t++)e=e*31+r.charCodeAt(t)>>>0;return o[e%o.length]},n=l.value.map(r=>{const e=s(r.name);return{name:r.name,type:"line",data:r.data.map(t=>a.sortMetric==="turnover"?t.turnoverRateFQuantile:t.amountCongestionQuantile),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:e},itemStyle:{color:e}}}),i=a.sortMetric==="turnover"?"等权换手率分位数":"成交金额占比分位数";return{title:{text:`${a.searchKeyword} - ${i}趋势`,left:"center",textStyle:{fontSize:16}},tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:l.value.map(r=>r.name),top:"8%",type:"scroll"},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:a.dates.map(r=>r.substring(5)),axisLabel:{rotate:45}},yAxis:{type:"value",name:i,nameLocation:"middle",nameGap:50},series:n}},v=o=>{y("chart-ready",o)},w=o=>{const s=o?.data,[n,i,r]=s??[],e=typeof i=="number"?l.value[i]:void 0,t=typeof n=="number"?a.dates[n]:void 0;y("chart-click",{industry:e?{name:e.name}:void 0,date:t,value:r,metric:a.sortMetric??"amount",rawParams:o})};return(o,s)=>(R(),B(K,{option:m.value,onChartReady:v,onChartClick:w},null,8,["option"]))}}),U=T(G,[["__scopeId","data-v-5dd4a692"]]),j={class:"turnover-analysis"},J={class:"controls"},X={class:"chart-container"},Y=M({__name:"TurnoverAnalysis",props:{industryWhitelist:{default:()=>[]}},setup(p){const u=p,a=O(),y=d("amount"),l=d("20"),m=d(!0),f=d(!1),h=d([]),v=d([]),w=L(()=>{if(!u.industryWhitelist||u.industryWhitelist.length===0)return h.value;const e=new Set(u.industryWhitelist.map(t=>t.trim().toLowerCase()));return h.value.filter(t=>e.has(t.name.trim().toLowerCase()))}),o=async()=>{f.value=!0;try{const e=new Date,t=e.toISOString().split("T")[0],g=l.value==="all"?30:parseInt(l.value),C=new Date(e);C.setDate(e.getDate()-g);const E=C.toISOString().split("T")[0],D=await q(E,t);if(D){const x=D.data;if(!Array.isArray(x))throw console.error("API返回的数据不是数组:",x),new Error("API返回的数据格式不正确");const b=[...new Set(x.map(c=>c.date))].sort();v.value=b;const _=new Map;x.forEach(c=>{_.has(c.sector_code)||_.set(c.sector_code,{name:c.sector_name,data:[]});const S=_.get(c.sector_code),Q=b.indexOf(c.date);for(;S.data.length<b.length;)S.data.push({turnoverRateFQuantile:0,amountCongestionQuantile:0});S.data[Q]={turnoverRateFQuantile:c.turnover_ratio_percentile,amountCongestionQuantile:c.turnover_ratio_percentile}}),h.value=Array.from(_.values())}else I.error("获取数据失败")}catch(e){console.error("获取数据出错:",e),I.error("获取数据出错，请检查网络连接或API服务是否可用")}finally{f.value=!1}},s=()=>{o()},n=()=>{m.value=!m.value},i=e=>{},r=e=>{console.log("Chart clicked payload:",e);const t=e?.industry?.name;t&&(a.push({path:"/stock-list",query:{industry:t}}),I.success(`正在跳转到 ${t} 行业的股票列表`))};return F(()=>{o()}),(e,t)=>{const g=N("el-button");return R(),$("div",j,[k("div",J,[A(H,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=C=>l.value=C),onChange:s,style:{"margin-right":"10px"}},null,8,["modelValue"]),A(g,{onClick:n,type:"primary"},{default:P(()=>[...t[1]||(t[1]=[V("按最后一列排序",-1)])]),_:1})]),k("div",X,[A(U,{industries:w.value,dates:v.value,"sort-metric":y.value,"sort-ascending":m.value,onChartReady:i,onChartClick:r},null,8,["industries","dates","sort-metric","sort-ascending"])])])}}}),nt=T(Y,[["__scopeId","data-v-4533d3ae"]]);export{nt as T};
