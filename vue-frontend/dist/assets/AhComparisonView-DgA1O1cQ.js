import{x as _e,d as ve,a as _,z as v,y as he,C as fe,f as N,w as l,H as ge,i as c,e as n,D as be,k as H,G as ye,c as y,g as L,b as s,t as o,F as G,A as J,l as ke,R as Ce,L as z,o as d,_ as xe}from"./index-Bun73MF3.js";import{i as K,L as Ae}from"./index-ElshY9iF.js";async function Q(I){return(await _e.get("/django/api/tasks/ah-comparison/",{params:I})).data}const we={key:0,class:"metrics-container"},De={class:"metric-value"},Ne={class:"metric-value success-text"},He={class:"metric-value danger-text"},$e={key:1,class:"charts-section"},Le={class:"chart-wrapper"},Ve={class:"chart-title"},Fe={class:"chart-wrapper"},Se={class:"chart-title"},Me={class:"opportunity-lists"},Re={class:"opp-list"},Te=["onClick"],Ye={class:"stock-name"},ze={class:"premium-val success-text"},Ie={class:"opp-list"},Oe=["onClick"],Ee={class:"stock-name"},Pe={class:"premium-val danger-text"},je={class:"chart-wrapper"},Be={key:0,class:"stock-detail-card"},Ue={class:"detail-row"},qe={class:"value"},Ge={class:"detail-row"},Je={class:"value"},Ke={class:"detail-row"},Qe={class:"value highlight"},We={class:"detail-desc"},Xe=["onClick"],Ze={class:"stock-name link-text"},et={class:"stock-code"},tt=["onClick"],st={class:"stock-name link-text"},at={class:"stock-code"},lt={class:"premium-cell"},nt={class:"premium-tag"},ot=ve({__name:"AhComparisonView",setup(I){const x=_(!1),k=_(""),V=_([]),F=_(null);let A=null;const S=_(!1),O=_(""),M=_(null),R=_(null);let p=null;_(!1);const D=v(()=>V.value.length>0),E=v(()=>!1),h=v(()=>V.value),f=v(()=>h.value[0]),W=v(()=>{const e=h.value;return e.length?(e.reduce((r,i)=>r+Number(i.ah_premium||0),0)/e.length).toFixed(2):0}),X=v(()=>h.value.filter(e=>Number(e.ah_premium)<0).length),Z=v(()=>h.value.filter(e=>Number(e.ah_premium)>0).length),ee=v(()=>[...h.value].sort((e,t)=>Number(e.ah_premium)-Number(t.ah_premium)).slice(0,5)),te=v(()=>[...h.value].sort((e,t)=>Number(t.ah_premium)-Number(e.ah_premium)).slice(0,5));function P(e){if(!e)return[];if(Array.isArray(e.records)&&e.records.length>0)return e.records;if(Array.isArray(e.items)&&Array.isArray(e.fields)){const t=e.fields;return e.items.map(r=>{const i={};return t.forEach((u,C)=>i[u]=r[C]),i})}return[]}async function j(){if(k.value){x.value=!0;try{const e={trade_date:k.value},t=await Q(e);V.value=P(t),ge(()=>{ne()})}finally{x.value=!1}}}function B(e){const t=Number(e);return t>0?"text-red":t<0?"text-green":""}function se(e){return Number(e)>0?"text-red":"text-green"}function ae(e){return Number(e)>0?"#F56C6C":"#67C23A"}function le(e){return!e||e.length!==8?e:`${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6,8)}`}function ne(){if(!F.value||!D.value)return;A&&A.dispose(),A=K(F.value);const e={"<-20%":0,"-20%~0%":0,"0%~20%":0,"20%~50%":0,">50%":0};h.value.forEach(r=>{const i=Number(r.ah_premium);i<-20?e["<-20%"]++:i<0?e["-20%~0%"]++:i<20?e["0%~20%"]++:i<50?e["20%~50%"]++:e[">50%"]++});const t={title:{text:"市场AH溢价率分布"},tooltip:{trigger:"item"},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"category",data:Object.keys(e)},yAxis:{type:"value",name:"股票数量"},series:[{name:"股票数量",type:"bar",data:Object.values(e),itemStyle:{color:r=>r.dataIndex<2?"#67C23A":"#F56C6C"},label:{show:!0,position:"top"}}]};A.setOption(t)}function $(e){R.value=e,O.value=`${e.name} (${e.ts_code}) - AH溢价率历史走势`,S.value=!0}function U(){const e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${t}${r}${i}`}function oe(e){const t=parseInt(e.slice(0,4)),r=parseInt(e.slice(4,6))-1,i=parseInt(e.slice(6,8)),u=new Date(t,r,i);u.setFullYear(u.getFullYear()-1);const C=u.getFullYear(),g=String(u.getMonth()+1).padStart(2,"0"),m=String(u.getDate()).padStart(2,"0");return`${C}${g}${m}`}async function ie(){if(!(!M.value||!R.value)){p&&p.dispose(),p=K(M.value),p.showLoading();try{const e=k.value||U(),t=oe(e),r={ts_code:R.value.ts_code,start_date:t,end_date:e},i=await Q(r),u=P(i).sort((b,T)=>b.trade_date.localeCompare(T.trade_date)),C=u.map(b=>b.trade_date),g=u.map(b=>b.ah_premium),m={tooltip:{trigger:"axis"},grid:{left:"3%",right:"4%",bottom:"10%",containLabel:!0},xAxis:{type:"category",data:C,axisLabel:{rotate:45}},yAxis:{type:"value",name:"溢价率(%)",scale:!0},series:[{name:"AH溢价率",type:"line",data:g,smooth:!0,markLine:{data:[{yAxis:0,name:"平价线"}]},itemStyle:{color:"#409EFF"},areaStyle:{color:new Ae(0,0,0,1,[{offset:0,color:"rgba(64,158,255,0.5)"},{offset:1,color:"rgba(64,158,255,0.01)"}])}}]};p.setOption(m)}catch(e){console.error("Fetch trend data failed",e),p.setOption({title:{text:"数据加载失败",left:"center",top:"center"}})}finally{p.hideLoading()}}}function q(){A?.resize(),p?.resize()}return he(()=>{window.addEventListener("resize",q),k.value=U(),j()}),fe(()=>{window.removeEventListener("resize",q),A?.dispose(),p?.dispose()}),(e,t)=>{const r=c("el-date-picker"),i=c("el-form-item"),u=c("el-button"),C=c("el-form"),g=c("el-card"),m=c("el-col"),b=c("el-row"),T=c("el-tag"),w=c("el-table-column"),re=c("el-icon"),ce=c("el-progress"),de=c("el-table"),ue=c("el-empty"),me=c("el-dialog"),pe=ye("loading");return d(),N(g,{class:"page-card"},{header:l(()=>[...t[2]||(t[2]=[s("div",{class:"card-header"},"AH股比价查询",-1)])]),default:l(()=>[n(C,{inline:!0,class:"query-form"},{default:l(()=>[n(i,{label:"选择日期"},{default:l(()=>[n(r,{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=a=>k.value=a),type:"date",placeholder:"选择日期","value-format":"YYYYMMDD",clearable:!1},null,8,["modelValue"])]),_:1}),n(i,null,{default:l(()=>[n(u,{type:"primary",loading:x.value,onClick:j},{default:l(()=>[...t[3]||(t[3]=[H("查询",-1)])]),_:1},8,["loading"])]),_:1})]),_:1}),be((d(),y("div",null,[D.value?(d(),y("div",we,[n(b,{gutter:20},{default:l(()=>[n(m,{span:8},{default:l(()=>[n(g,{shadow:"hover",class:"metric-card bg-blue-light"},{default:l(()=>[t[4]||(t[4]=s("div",{class:"metric-title"},"平均溢价率 (A/H)",-1)),s("div",De,o(W.value)+"%",1),t[5]||(t[5]=s("div",{class:"metric-desc"},"整体市场估值水平",-1))]),_:1})]),_:1}),n(m,{span:8},{default:l(()=>[n(g,{shadow:"hover",class:"metric-card bg-green-light"},{default:l(()=>[t[7]||(t[7]=s("div",{class:"metric-title"},"A股折价 (A便宜)",-1)),s("div",Ne,[H(o(X.value)+" ",1),t[6]||(t[6]=s("span",{class:"unit"},"只",-1))]),t[8]||(t[8]=s("div",{class:"metric-desc"},"溢价率 < 0%",-1))]),_:1})]),_:1}),n(m,{span:8},{default:l(()=>[n(g,{shadow:"hover",class:"metric-card bg-red-light"},{default:l(()=>[t[10]||(t[10]=s("div",{class:"metric-title"},"A股溢价 (H便宜)",-1)),s("div",He,[H(o(Z.value)+" ",1),t[9]||(t[9]=s("span",{class:"unit"},"只",-1))]),t[11]||(t[11]=s("div",{class:"metric-desc"},"溢价率 > 0%",-1))]),_:1})]),_:1})]),_:1})])):L("",!0),D.value?(d(),y("div",$e,[n(b,{gutter:20},{default:l(()=>[n(m,{span:12},{default:l(()=>[s("div",Le,[s("div",Ve,o(E.value?"AH溢价率走势":"当前日期 AH溢价率分布"),1),s("div",{ref_key:"mainChartRef",ref:F,class:"chart-box"},null,512)])]),_:1}),E.value?(d(),N(m,{key:1,span:12},{default:l(()=>[s("div",je,[t[17]||(t[17]=s("div",{class:"chart-title"},"最新价差详情",-1)),f.value?(d(),y("div",Be,[s("div",Ue,[t[14]||(t[14]=s("span",{class:"label"},"A股价格:",-1)),s("span",qe,o(f.value.close)+" ("+o(f.value.pct_chg)+"%)",1)]),s("div",Ge,[t[15]||(t[15]=s("span",{class:"label"},"H股价格:",-1)),s("span",Je,o(f.value.hk_close)+" ("+o(f.value.hk_pct_chg)+"%)",1)]),s("div",Ke,[t[16]||(t[16]=s("span",{class:"label"},"当前溢价:",-1)),s("span",Qe,o(f.value.ah_premium)+"%",1)]),s("div",We,[n(T,{type:Number(f.value.ah_premium)>0?"danger":"success"},{default:l(()=>[H(o(Number(f.value.ah_premium)>0?"A股更贵 (H股划算)":"A股更便宜 (A股划算)"),1)]),_:1},8,["type"])])])):L("",!0)])]),_:1})):(d(),N(m,{key:0,span:12},{default:l(()=>[s("div",Fe,[s("div",Se,"高性价比机会 (Top 5) - "+o(le(k.value)),1),s("div",Me,[s("div",Re,[t[12]||(t[12]=s("div",{class:"list-header success-bg"},"A股最便宜 (折价最高)",-1)),(d(!0),y(G,null,J(ee.value,a=>(d(),y("div",{key:a.ts_code,class:"list-item clickable",onClick:Y=>$(a)},[s("span",Ye,o(a.name),1),s("span",ze,o(a.ah_premium)+"%",1)],8,Te))),128))]),s("div",Ie,[t[13]||(t[13]=s("div",{class:"list-header danger-bg"},"H股最便宜 (溢价最高)",-1)),(d(!0),y(G,null,J(te.value,a=>(d(),y("div",{key:a.ts_code,class:"list-item clickable",onClick:Y=>$(a)},[s("span",Ee,o(a.name),1),s("span",Pe,o(a.ah_premium)+"%",1)],8,Oe))),128))])])])]),_:1}))]),_:1})])):L("",!0),D.value?(d(),N(de,{key:2,data:h.value,border:"",stripe:"",style:{width:"100%","margin-top":"20px"},"default-sort":{prop:"ah_premium",order:"descending"}},{default:l(()=>[n(w,{label:"日期",prop:"trade_date",width:"100",sortable:""}),n(w,{label:"A股信息","min-width":"160"},{default:l(({row:a})=>[s("div",{class:"stock-cell clickable",onClick:Y=>$(a),title:"点击查看走势"},[s("span",Ze,[H(o(a.name)+" ",1),n(re,null,{default:l(()=>[n(ke(Ce))]),_:1})]),s("span",et,o(a.ts_code),1)],8,Xe)]),_:1}),n(w,{label:"A股收盘/涨跌","min-width":"140"},{default:l(({row:a})=>[s("div",{class:z(B(a.pct_chg))},o(a.close)+" ("+o(a.pct_chg)+"%) ",3)]),_:1}),n(w,{label:"H股信息","min-width":"160"},{default:l(({row:a})=>[s("div",{class:"stock-cell clickable",onClick:Y=>$(a),title:"点击查看走势"},[s("span",st,o(a.hk_name),1),s("span",at,o(a.hk_code),1)],8,tt)]),_:1}),n(w,{label:"H股收盘/涨跌","min-width":"140"},{default:l(({row:a})=>[s("div",{class:z(B(a.hk_pct_chg))},o(a.hk_close)+" ("+o(a.hk_pct_chg)+"%) ",3)]),_:1}),n(w,{label:"AH溢价率",prop:"ah_premium","min-width":"180",sortable:""},{default:l(({row:a})=>[s("div",lt,[s("span",{class:z([se(a.ah_premium),"premium-text"])},o(a.ah_premium)+"% ",3),n(ce,{percentage:Math.min(Math.abs(Number(a.ah_premium)),100),color:ae(a.ah_premium),"show-text":!1,"stroke-width":6},null,8,["percentage","color"]),s("span",nt,o(Number(a.ah_premium)>0?"H股便宜":"A股便宜"),1)])]),_:1})]),_:1},8,["data"])):!x.value&&!D.value?(d(),N(ue,{key:3,description:"暂无数据，请查询"})):L("",!0)])),[[pe,x.value]]),n(me,{modelValue:S.value,"onUpdate:modelValue":t[1]||(t[1]=a=>S.value=a),title:O.value,width:"800px",onOpened:ie,"destroy-on-close":""},{default:l(()=>[s("div",{ref_key:"trendChartRef",ref:M,style:{width:"100%",height:"400px"}},null,512)]),_:1},8,["modelValue","title"])]),_:1})}}}),ct=xe(ot,[["__scopeId","data-v-a8d5ba27"]]);export{ct as default};
