import{d as A,a as v,z as b,B as V,y as R,C as q,c as i,b as a,D as H,$ as K,F as X,A as Y,t as f,g as j,W as G,u as J,H as Q,o as u,_ as Z}from"./index-DUOcnsZX.js";import{i as ee}from"./index-ElshY9iF.js";import{a as te}from"./industryApi-DGnWVcBG.js";const ae={class:"industry-treemap"},se={class:"control-panel"},ne={class:"metric-selector"},oe=["value"],le={class:"refresh-controls"},re=["disabled"],ie={key:0},ue={key:1},de={key:0,class:"update-time"},ce={key:0,class:"loading-container"},fe={key:1,class:"error-container"},ve={class:"error-message"},me={key:2,class:"treemap-container"},pe={class:"chart-info"},he={class:"statistics"},be={class:"stats-grid"},ye={class:"stat-item"},_e={class:"stat-value"},ge={class:"stat-item"},ke={class:"stat-value"},we={class:"stat-item"},xe={class:"stat-value"},Ce={class:"stat-item"},Se={class:"stat-value"},De=A({__name:"IndustryTreemap",props:{industryWhitelist:{default:()=>[]}},setup(W){const y=W,M=J(),m=v(!1),_=v(null),d=v([]),l=v("total_market_cap_sum"),D=v(null),g=v();let o=null;const k=[{key:"total_market_cap_sum",label:"总市值",unit:"元",isPercent:!1},{key:"circulating_market_cap_sum",label:"流通市值",unit:"元",isPercent:!1},{key:"avg_change_percent",label:"平均涨跌幅",unit:"%",isPercent:!0},{key:"total_volume",label:"总成交量",unit:"手",isPercent:!1},{key:"total_amount",label:"总成交额",unit:"元",isPercent:!1},{key:"avg_turnover_rate",label:"平均换手率",unit:"%",isPercent:!0},{key:"avg_pe_ratio",label:"平均市盈率",unit:"",isPercent:!1},{key:"avg_pb_ratio",label:"平均市净率",unit:"",isPercent:!1},{key:"stock_count",label:"股票数量",unit:"只",isPercent:!1},{key:"avg_change_60d",label:"60日平均涨跌幅",unit:"%",isPercent:!0},{key:"avg_change_ytd",label:"年初至今平均涨跌幅",unit:"%",isPercent:!0}],I=b(()=>k.find(e=>e.key===l.value)?.label||""),p=b(()=>{if(!y.industryWhitelist||y.industryWhitelist.length===0)return d.value;const t=new Set(y.industryWhitelist.map(e=>e.trim().toLowerCase()));return d.value.filter(e=>t.has(e.industry.trim().toLowerCase()))});V(()=>y.industryWhitelist,()=>{w()},{deep:!0}),V(p,()=>{w()});const E=b(()=>p.value?.length||0),T=b(()=>{const t=p.value;return!t||t.length===0?0:Math.max(...t.map(e=>e[l.value]))}),z=b(()=>{const t=p.value;return!t||t.length===0?0:Math.min(...t.map(e=>e[l.value]))});async function N(){try{m.value=!0,_.value=null,console.log("开始加载行业数据...");const t=await te();console.log("API响应数据:",t),d.value=t.industries||[],console.log("设置industryData:",d.value),console.log("数据条数:",d.value?.length||0),D.value=new Date}catch(t){_.value=t instanceof Error?t.message:"加载数据失败",console.error("Failed to load industry data:",t)}finally{m.value=!1,await Q(),console.log("DOM更新完成，开始更新树图"),w()}}async function F(){await N()}function L(t){const e=t.data.name;console.log("点击行业:",e),M.push({path:"/stock-list",query:{industry:e}})}function w(){if(console.log("updateTreemap被调用"),console.log("treemapChart.value:",g.value),console.log("industryData.value:",d.value),console.log("industryData长度:",d.value?.length||0),!g.value){console.error("treemapChart容器未找到");return}const t=p.value;if(!t||t.length===0){console.error("可见数据为空或未定义"),o&&(o.setOption({title:{text:"暂无数据",left:"center",top:"center"}}),o.resize());return}o||(console.log("初始化ECharts实例"),o=ee(g.value));const e=k.find(s=>s.key===l.value);console.log("当前选择的指标:",e);const r=t.map(s=>{const c=s[l.value],h=typeof c=="number"?c:Number(c),C=Number.isNaN(h)?0:h,S=typeof s.stock_count=="number"&&s.stock_count>0?s.stock_count:1,$=C;return{name:s.industry,value:$,stockCount:S,metricKey:l.value}}).map(s=>({name:s.name,value:Math.abs(s.value),children:[{name:`${s.name}`,value:Math.abs(s.value),originalValue:s.value,label:{show:!0,formatter:c=>`${c.name}
${x(c.data.originalValue)}`},itemStyle:{color:s.value>0?"#73C0DE":s.value<0?"#EE6666":"#999"}}]})),O={title:{text:`行业矩形树图（${e?.label||""}）`,left:"center"},tooltip:{formatter:s=>{const h=(typeof s?.name=="string"?s.name:"").replace(/\s*\(.+\)\s*$/,""),C=s?.data&&"originalValue"in s.data?Number(s.data.originalValue):void 0,S=t.find(U=>U.industry===h),$=C!==void 0?C:S?S[l.value]:0;return`${h}<br/>${e?.label||""}: ${x(Number($))}`}},series:[{type:"treemap",data:r,roam:!0,nodeClick:!1,breadcrumb:{show:!1},label:{show:!0,color:"#2c3e50",textShadowColor:"rgba(255,255,255,0.9)",textShadowBlur:2,textShadowOffsetX:0,textShadowOffsetY:0},itemStyle:{borderColor:"#ffffff",borderWidth:1,gapWidth:2},levels:[{itemStyle:{borderColor:"#e5e7eb",borderWidth:1,gapWidth:3},upperLabel:{show:!1}},{itemStyle:{borderColor:"#ffffff",borderWidth:1,gapWidth:2}}],emphasis:{itemStyle:{borderColor:"#409EFF",borderWidth:2}}}]};o.setOption(O),o.resize(),o.off("click"),o.on("click",L)}function P(){o&&o.resize()}R(async()=>{await N(),window.addEventListener("resize",P)}),q(()=>{window.removeEventListener("resize",P),o&&(o.dispose(),o=null)});function x(t){const e=k.find(r=>r.key===l.value),n=typeof t=="number"?t:Number(t);if(Number.isNaN(n))return"--";if(e?.isPercent)return`${n.toFixed(2)}%`;if(e?.unit==="元"){const r=Math.abs(n);return r>=1e12?`${(n/1e12).toFixed(2)}万亿`:r>=1e8?`${(n/1e8).toFixed(2)}亿`:r>=1e4?`${(n/1e4).toFixed(2)}万`:n.toFixed(2)}if(e?.unit==="手"){const r=Math.abs(n);return r>=1e8?`${(n/1e8).toFixed(2)}亿手`:r>=1e4?`${(n/1e4).toFixed(2)}万手`:`${n.toFixed(2)}手`}return e?.unit?`${n.toFixed(2)}${e.unit}`:n.toFixed(2)}function B(t){try{return new Date(t).toLocaleString("zh-CN")}catch{return""}}return(t,e)=>(u(),i("div",ae,[a("div",se,[a("div",ne,[e[1]||(e[1]=a("label",{for:"metric-select"},"选择指标：",-1)),H(a("select",{id:"metric-select","onUpdate:modelValue":e[0]||(e[0]=n=>l.value=n),onChange:w,class:"metric-select"},[(u(),i(X,null,Y(k,n=>a("option",{key:n.key,value:n.key},f(n.label),9,oe)),64))],544),[[K,l.value]])]),a("div",le,[a("button",{onClick:F,disabled:m.value,class:"refresh-btn"},[m.value?(u(),i("span",ie,"刷新中...")):(u(),i("span",ue,"刷新数据"))],8,re),D.value?(u(),i("span",de," 最后更新："+f(B(D.value)),1)):j("",!0)])]),m.value?(u(),i("div",ce,[...e[2]||(e[2]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"正在加载行业数据...",-1)])])):_.value?(u(),i("div",fe,[a("div",ve,[e[3]||(e[3]=a("h3",null,"数据加载失败",-1)),a("p",null,f(_.value),1),a("button",{onClick:F,class:"retry-btn"},"重试")])])):(u(),i("div",me,[a("div",{ref_key:"treemapChart",ref:g,class:"treemap-chart"},null,512),a("div",pe,[e[9]||(e[9]=G('<div class="legend" data-v-de2ff2f5><h4 data-v-de2ff2f5>图例说明</h4><div class="legend-items" data-v-de2ff2f5><div class="legend-item positive" data-v-de2ff2f5><span class="color-box positive" data-v-de2ff2f5></span><span data-v-de2ff2f5>正值/上涨</span></div><div class="legend-item negative" data-v-de2ff2f5><span class="color-box negative" data-v-de2ff2f5></span><span data-v-de2ff2f5>负值/下跌</span></div><div class="legend-item neutral" data-v-de2ff2f5><span class="color-box neutral" data-v-de2ff2f5></span><span data-v-de2ff2f5>中性/无变化</span></div></div></div>',1)),a("div",he,[e[8]||(e[8]=a("h4",null,"统计信息",-1)),a("div",be,[a("div",ye,[e[4]||(e[4]=a("span",{class:"stat-label"},"行业总数：",-1)),a("span",_e,f(E.value),1)]),a("div",ge,[e[5]||(e[5]=a("span",{class:"stat-label"},"当前指标：",-1)),a("span",ke,f(I.value),1)]),a("div",we,[e[6]||(e[6]=a("span",{class:"stat-label"},"最大值：",-1)),a("span",xe,f(x(T.value)),1)]),a("div",Ce,[e[7]||(e[7]=a("span",{class:"stat-label"},"最小值：",-1)),a("span",Se,f(x(z.value)),1)])])])])]))]))}}),Pe=Z(De,[["__scopeId","data-v-de2ff2f5"]]);export{Pe as I};
