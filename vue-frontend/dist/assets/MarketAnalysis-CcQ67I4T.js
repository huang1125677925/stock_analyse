import{J as q,d as Q,a as x,z as B,x as C,c as K,b as m,C as P,e as n,i as $,w as v,L as j,k as G,X as J,o as U,G as te,_ as Y,A as ae,D as oe,E as X,g as ne}from"./index-DZgUmUth.js";import"./index-ElshY9iF.js";import{H as W}from"./HeatmapChart-BX9gINY9.js";import{T as le}from"./TrendChart-C1ZOLy0r.js";const re="/django/api/market",E={main_net_inflow_amount:{name:"主力净流入金额",unit:"元",formatter:e=>e>=1e8?(e/1e8).toFixed(2)+"亿":e>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},small_net_inflow_amount:{name:"小单净流入金额",unit:"元",formatter:e=>e>=1e8?(e/1e8).toFixed(2)+"亿":e>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},medium_net_inflow_amount:{name:"中单净流入金额",unit:"元",formatter:e=>e>=1e8?(e/1e8).toFixed(2)+"亿":e>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},large_net_inflow_amount:{name:"大单净流入金额",unit:"元",formatter:e=>e>=1e8?(e/1e8).toFixed(2)+"亿":e>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},super_large_net_inflow_amount:{name:"超大单净流入金额",unit:"元",formatter:e=>e>=1e8?(e/1e8).toFixed(2)+"亿":e>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},main_net_inflow_ratio:{name:"主力净流入比例",unit:"%",formatter:e=>e.toFixed(2)},small_net_inflow_ratio:{name:"小单净流入比例",unit:"%",formatter:e=>e.toFixed(2)},medium_net_inflow_ratio:{name:"中单净流入比例",unit:"%",formatter:e=>e.toFixed(2)},large_net_inflow_ratio:{name:"大单净流入比例",unit:"%",formatter:e=>e.toFixed(2)},super_large_net_inflow_ratio:{name:"超大单净流入比例",unit:"%",formatter:e=>e.toFixed(2)},shanghai_close_price:{name:"上证收盘价",unit:"点",formatter:e=>e.toFixed(2)},shanghai_change_rate:{name:"上证涨跌幅",unit:"%",formatter:e=>e.toFixed(2)},shenzhen_close_price:{name:"深证收盘价",unit:"点",formatter:e=>e.toFixed(2)},shenzhen_change_rate:{name:"深证涨跌幅",unit:"%",formatter:e=>e.toFixed(2)}};async function ie(e,_,c=1,g=20,F="-date"){try{const i={page:c,page_size:g,order_by:F};return e&&(i.start_date=e),_&&(i.end_date=_),(await q.get(`${re}/fund-flow/`,{params:i})).data}catch(i){throw console.error("获取大盘资金流数据失败:",i),i}}const se={class:"market-fund-flow-heatmaps"},ce={class:"heatmap-toolbar"},de={class:"heatmap-section"},ue={class:"heatmap-section"},me=Q({name:"MarketFundFlowHeatmap",__name:"MarketFundFlowHeatmap",props:{data:{},selectedMetric:{default:"main_net_inflow_amount"},searchKeyword:{default:""},sortAscending:{type:Boolean,default:!1},valueFilter:{default:"all"}},emits:["chart-ready","chart-click"],setup(e,{emit:_}){const c=x("amount"),g=x(null),F=x(null);B(c,async t=>{await te(),t==="amount"?g.value?.resize():F.value?.resize(),setTimeout(()=>{t==="amount"?g.value?.resize():F.value?.resize()},50)});const i=e,p=_,A=C(()=>{if(!i.data)return[];let t=i.data;return i.searchKeyword?.trim()&&(t=i.data.filter(a=>a.date.toLowerCase().includes(i.searchKeyword.toLowerCase()))),[...t].sort((a,l)=>{const o=new Date(a.date).getTime(),d=new Date(l.date).getTime();return Number.isNaN(o)||Number.isNaN(d)?a.date.localeCompare(l.date):o-d})}),R=C(()=>Object.keys(E).filter(t=>t.endsWith("_amount"))),b=C(()=>Object.keys(E).filter(t=>t.endsWith("_ratio"))),k=(t,a,l)=>{const o=A.value;if(!o||o.length===0)return{title:{text:"暂无数据",left:"center",top:"center",textStyle:{fontSize:16,color:"#999"}}};const d=t.map(u=>E[u].name),r=o.map(u=>u.date),y=[];let f=1/0,h=-1/0;return o.forEach((u,D)=>{t.forEach((N,M)=>{const w=u[N];if(typeof w=="number"&&!isNaN(w)&&isFinite(w)){let I=!0;if((i.valueFilter==="positive"&&w<=0||i.valueFilter==="negative"&&w>=0)&&(I=!1),I){const S=N.endsWith("_amount")?w/1e8:w;y.push([D,M,S]),f=Math.min(f,S),h=Math.max(h,S)}}})}),(f===1/0||h===-1/0)&&(f=0,h=100),{title:{text:a,left:"center"},tooltip:{position:"top",formatter:function(u){const[D,N,M]=u.data,w=o[D],I=t[N],V=E[I],S=I.endsWith("_amount"),Z=S?Number(M).toFixed(2):V.formatter?V.formatter(M):Number(M).toFixed(2),ee=S?"亿":V.unit;return`${w.date}<br/>${V.name}: ${Z}${ee}`}},grid:{height:Math.max(240,t.length*24)+"px",top:"8%",left:"2%",right:"16%",bottom:"6%",containLabel:!0},xAxis:[{type:"category",data:r,splitArea:{show:!0},axisLabel:{fontSize:12}}],yAxis:[{type:"category",data:d,splitArea:{show:!0},axisLabel:{fontSize:11}}],visualMap:{min:f,max:h,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#00C853","#FF1744"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:a,type:"heatmap",data:y,label:{show:l,fontSize:9,formatter:function(u){const D=u.data[2];return t[u.data[1]].endsWith("_amount")?Number(D).toFixed(1)+"亿":Number(D).toFixed(1)}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}},z=C(()=>k(R.value,"金额热力图",!1)),L=C(()=>k(b.value,"比例热力图",!0));C(()=>[{key:"shanghai_close_price",label:"上证收盘价",color:"#409EFF",yAxisIndex:0},{key:"shanghai_change_rate",label:"上证涨跌幅(%)",color:"#67C23A",yAxisIndex:1}]);const T=t=>p("chart-ready",t),O=t=>p("chart-ready",t),H=t=>{const a=t?.data;if(!a)return;const[l,o,d]=a;if(typeof l!="number"||typeof o!="number")return;const r=A.value;if(l<0||l>=r.length||o<0||o>=R.value.length)return;const y=r[l],f=R.value[o],h=y?.date;p("chart-click",{date:h,value:d,metric:f,rawParams:t})},s=t=>{const a=t?.data;if(!a)return;const[l,o,d]=a;if(typeof l!="number"||typeof o!="number")return;const r=A.value;if(l<0||l>=r.length||o<0||o>=b.value.length)return;const y=r[l],f=b.value[o],h=y?.date;p("chart-click",{date:h,value:d,metric:f,rawParams:t})};return(t,a)=>{const l=$("el-button"),o=$("el-button-group");return U(),K("div",se,[m("div",ce,[n(o,null,{default:v(()=>[n(l,{type:"primary",plain:"",class:j({active:c.value==="amount"}),onClick:a[0]||(a[0]=d=>c.value="amount")},{default:v(()=>[...a[2]||(a[2]=[G("金额热力图",-1)])]),_:1},8,["class"]),n(l,{type:"primary",plain:"",class:j({active:c.value==="ratio"}),onClick:a[1]||(a[1]=d=>c.value="ratio")},{default:v(()=>[...a[3]||(a[3]=[G("比例热力图",-1)])]),_:1},8,["class"])]),_:1})]),P(m("div",de,[n(W,{ref_key:"amountChartRef",ref:g,option:z.value,onChartReady:T,onChartClick:H},null,8,["option"])],512),[[J,c.value==="amount"]]),P(m("div",ue,[n(W,{ref_key:"ratioChartRef",ref:F,option:L.value,onChartReady:O,onChartClick:s},null,8,["option"])],512),[[J,c.value==="ratio"]])])}}}),fe=Y(me,[["__scopeId","data-v-6aebdb21"]]),he="/django/api/market";async function _e(e){const{indexCode:_,startDate:c,endDate:g,limit:F}=e;return(await q.get(`${he}/rise-fall-ratio/`,{params:{index_code:_,start_date:c,end_date:g,limit:F}})).data?.results??[]}const pe={class:"market-analysis","element-loading-text":"正在加载大盘数据..."},ve={class:"fund-flow-section"},xe={class:"chart-header"},ye={class:"chart-controls"},ge={class:"chart-container"},Fe={key:0,class:"rise-fall-section"},we={class:"chart-header"},be={class:"chart-controls"},Ce={class:"chart-container"},ke=Q({__name:"MarketAnalysis",setup(e){const _=x(!1),c=x([]),g=x("main_net_inflow_amount"),F=x(""),i=x("all"),p=x(20);async function A(){try{_.value=!0;const s=new Date().toISOString().split("T")[0],t=new Date(Date.now()-p.value*24*60*60*1e3).toISOString().split("T")[0],a=await ie(t,s,1,p.value,"-date");c.value=a.list??[]}catch(s){console.error("获取大盘资金流数据出错:",s),X.error("获取大盘资金流数据出错")}finally{_.value=!1}}function R(s){console.log("fund flow chart click:",s)}const b=x("all"),k=x([]);async function z(){try{_.value=!0;const s=new Date().toISOString().split("T")[0],t=new Date(Date.now()-p.value*24*60*60*1e3).toISOString().split("T")[0],a=await _e({indexCode:b.value,startDate:t,endDate:s});k.value=[...a].sort((l,o)=>l.date.localeCompare(o.date))}catch(s){console.error("获取涨跌比数据出错:",s),X.error("获取涨跌比数据出错")}finally{_.value=!1}}const L=C(()=>{const s=k.value.map(r=>r.date),t=[{key:"rise_fall_ratio_20",label:"20日涨跌比"},{key:"rise_fall_ratio_60",label:"60日涨跌比"},{key:"rise_fall_ratio_120",label:"120日涨跌比"}],a=[],l=[];k.value.forEach((r,y)=>{t.forEach((f,h)=>{const u=r[f.key];typeof u=="number"&&(a.push(u),l.push([y,h,u]))})});const o=a.length?Math.min(...a):0,d=a.length?Math.max(...a):1;return{tooltip:{position:"top",formatter:r=>{const y=s[r.value[0]],f=t[r.value[1]].label,h=r.value[2];return`${y}<br/>${f}: ${h.toFixed(4)}`}},grid:{left:80,right:30,top:40,bottom:40},xAxis:{type:"category",data:s,axisLabel:{rotate:45}},yAxis:{type:"category",data:t.map(r=>r.label)},visualMap:{min:o,max:d,calculable:!0,orient:"horizontal",left:"center",bottom:0,inRange:{color:["#50a3ba","#eac763","#d94e5d"]}},series:[{name:"涨跌比热力图",type:"heatmap",data:l,progressive:0,label:{show:!1}}]}});function T(s){console.log("rise-fall chart click:",s)}ae(()=>{A(),z()}),B(p,()=>{A(),z()}),B(b,()=>{z()});const O=[{key:"shanghai_close_price",label:"上证收盘价",color:"#409EFF",yAxisIndex:0},{key:"shanghai_change_rate",label:"上证涨跌幅(%)",color:"#67C23A",yAxisIndex:1}],H=C(()=>c?.value??[]);return(s,t)=>{const a=$("el-option"),l=$("el-select"),o=$("el-card"),d=oe("loading");return P((U(),K("div",pe,[m("div",ve,[n(o,{shadow:"hover"},{header:v(()=>[m("div",xe,[t[3]||(t[3]=m("h3",null,"大盘资金流热力图",-1)),m("div",ye,[n(l,{modelValue:p.value,"onUpdate:modelValue":t[0]||(t[0]=r=>p.value=r),placeholder:"时间范围",style:{width:"120px","margin-right":"10px"}},{default:v(()=>[n(a,{label:"20天",value:20}),n(a,{label:"30天",value:30}),n(a,{label:"40天",value:40}),n(a,{label:"60天",value:60}),n(a,{label:"90天",value:90}),n(a,{label:"120天",value:120}),n(a,{label:"180天",value:180})]),_:1},8,["modelValue"]),n(l,{modelValue:i.value,"onUpdate:modelValue":t[1]||(t[1]=r=>i.value=r),placeholder:"数值过滤",style:{width:"120px","margin-right":"10px"}},{default:v(()=>[n(a,{label:"全部",value:"all"}),n(a,{label:"正值",value:"positive"}),n(a,{label:"负值",value:"negative"})]),_:1},8,["modelValue"])])])]),default:v(()=>[m("div",ge,[n(fe,{data:c.value,selectedMetric:g.value,searchKeyword:F.value,valueFilter:i.value,onChartClick:R},null,8,["data","selectedMetric","searchKeyword","valueFilter"])])]),_:1}),n(o,{class:"mt-16",shadow:"never"},{header:v(()=>[...t[4]||(t[4]=[m("div",{class:"chart-header"},[m("span",null,"收盘价与涨跌幅趋势")],-1)])]),default:v(()=>[n(le,{data:H.value,"date-field":"date",yFields:O,defaultSelectedFields:["shanghai_close_price","shanghai_change_rate"],height:"420px",title:"收盘价与涨跌幅趋势"},null,8,["data"]),k.value.length>0?(U(),K("div",Fe,[n(o,{class:"mt-16",shadow:"hover"},{header:v(()=>[m("div",we,[t[5]||(t[5]=m("h3",null,"新高新低比热力图",-1)),m("div",be,[n(l,{modelValue:b.value,"onUpdate:modelValue":t[2]||(t[2]=r=>b.value=r),placeholder:"指数代码",style:{width:"160px"}},{default:v(()=>[n(a,{label:"全部A股",value:"all"}),n(a,{label:"上证50",value:"sz50"}),n(a,{label:"沪深300",value:"hs300"}),n(a,{label:"中证500",value:"zz500"})]),_:1},8,["modelValue"])])])]),default:v(()=>[m("div",Ce,[n(W,{option:L.value,height:480,onChartClick:T},null,8,["option"])])]),_:1})])):ne("",!0)]),_:1})])])),[[d,_.value]])}}}),Se=Y(ke,[["__scopeId","data-v-676a7faf"]]);export{Se as default};
