import{d as oe,a as y,z as ee,f as R,w as e,i as c,c as w,g as P,e as t,k as i,t as r,b as l,F as ne,y as re,I as J,E as U,o as v,_ as ie,r as X,A as fe,G as ge,C as ke,D as be,h as Z,u as ye}from"./index-Bb9pCaXo.js";import{b as we,d as he,g as Ce,r as xe,a as $e}from"./quantBacktestApi-Cm4s7RxQ.js";const ze={key:0,class:"loading-container"},De={key:1,class:"result-container"},Se={key:0,class:"strategy-params"},Ve={class:"metric-item"},Te={class:"metric-value"},Ne={class:"metric-item"},Be={class:"metric-value"},Re={class:"metric-item"},Fe={class:"metric-item"},Le={class:"metric-item"},Ie={class:"metric-value"},Ue={class:"metric-item"},Pe={class:"metric-value negative"},Ee={class:"metric-item"},Me={class:"metric-value"},je={class:"metric-item"},He={class:"metric-value"},Ae={class:"metric-item"},Ge={class:"metric-value"},Oe={class:"metric-item"},Ye={class:"metric-value positive"},qe={class:"metric-item"},Je={class:"metric-value negative"},Ke={class:"card-header"},Qe={class:"trade-count"},We={key:2,class:"error-container"},Xe=oe({__name:"BacktestResultDialog",props:{visible:{type:Boolean},taskId:{}},emits:["update:visible"],setup(te,{emit:K}){const m=te,f=K,n=y(null),N=y(!1),d=y(""),F=async()=>{if(!m.taskId){d.value="任务ID不能为空";return}N.value=!0,d.value="",n.value=null;try{n.value=await we(m.taskId)}catch(_){console.error("加载回测结果失败:",_),d.value=_.message||"加载回测结果失败",U.error("加载回测结果失败")}finally{N.value=!1}},D=()=>{f("update:visible",!1),n.value=null,d.value=""};ee(()=>m.visible,_=>{_&&m.taskId&&F()});const h=_=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}).format(_),S=_=>_==null?"-":`${_.toFixed(2)}%`,V=_=>new Date(_).toLocaleString("zh-CN"),B=_=>_>0?"positive":_<0?"negative":"";return(_,u)=>{const C=c("el-skeleton"),b=c("el-descriptions-item"),j=c("el-descriptions"),E=c("el-card"),k=c("el-col"),L=c("el-row"),x=c("el-table-column"),H=c("el-tag"),Q=c("el-table"),A=c("el-button"),W=c("el-result"),G=c("el-dialog");return v(),R(G,{"model-value":_.visible,"onUpdate:modelValue":D,title:"回测结果详情",width:"90%","close-on-click-modal":!1,"before-close":D},{footer:e(()=>[t(A,{onClick:D},{default:e(()=>[...u[16]||(u[16]=[i("关闭",-1)])]),_:1})]),default:e(()=>[N.value?(v(),w("div",ze,[t(C,{rows:10,animated:""})])):n.value?(v(),w("div",De,[t(E,{class:"info-card",shadow:"never"},{header:e(()=>[...u[0]||(u[0]=[l("div",{class:"card-header"},[l("span",null,"基本信息")],-1)])]),default:e(()=>[t(j,{column:3,border:""},{default:e(()=>[t(b,{label:"任务ID"},{default:e(()=>[i(r(n.value.task_info.task_id),1)]),_:1}),t(b,{label:"策略名称"},{default:e(()=>[i(r(n.value.task_info.strategy_name),1)]),_:1}),t(b,{label:"股票代码"},{default:e(()=>[i(r(n.value.task_info.stock_code),1)]),_:1}),t(b,{label:"股票名称"},{default:e(()=>[i(r(n.value.task_info.stock_name),1)]),_:1}),t(b,{label:"开始日期"},{default:e(()=>[i(r(n.value.task_info.start_date),1)]),_:1}),t(b,{label:"结束日期"},{default:e(()=>[i(r(n.value.task_info.end_date),1)]),_:1}),t(b,{label:"初始资金"},{default:e(()=>[i(r(h(n.value.task_info.initial_cash)),1)]),_:1}),t(b,{label:"手续费率"},{default:e(()=>[i(r(S(n.value.task_info.commission)),1)]),_:1}),t(b,{label:"创建时间"},{default:e(()=>[i(r(V(n.value.task_info.created_at)),1)]),_:1}),t(b,{label:"完成时间"},{default:e(()=>[i(r(V(n.value.task_info.completed_at)),1)]),_:1})]),_:1}),n.value.task_info.strategy_params&&Object.keys(n.value.task_info.strategy_params).length>0?(v(),w("div",Se,[u[1]||(u[1]=l("h4",null,"策略参数",-1)),t(j,{column:2,border:""},{default:e(()=>[(v(!0),w(ne,null,re(n.value.task_info.strategy_params,(g,M)=>(v(),R(b,{key:M,label:M},{default:e(()=>[i(r(g),1)]),_:2},1032,["label"]))),128))]),_:1})])):P("",!0)]),_:1}),t(E,{class:"performance-card",shadow:"never"},{header:e(()=>[...u[2]||(u[2]=[l("div",{class:"card-header"},[l("span",null,"绩效指标")],-1)])]),default:e(()=>[t(L,{gutter:16},{default:e(()=>[t(k,{span:6},{default:e(()=>[l("div",Ve,[u[3]||(u[3]=l("div",{class:"metric-label"},"初始价值",-1)),l("div",Te,r(h(n.value.performance.initial_value)),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",Ne,[u[4]||(u[4]=l("div",{class:"metric-label"},"最终价值",-1)),l("div",Be,r(h(n.value.performance.final_value)),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",Re,[u[5]||(u[5]=l("div",{class:"metric-label"},"总收益率",-1)),l("div",{class:J(["metric-value",B(n.value.performance.total_return)])},r(S(n.value.performance.total_return)),3)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",Fe,[u[6]||(u[6]=l("div",{class:"metric-label"},"年化收益率",-1)),l("div",{class:J(["metric-value",B(n.value.performance.annual_return)])},r(S(n.value.performance.annual_return)),3)])]),_:1})]),_:1}),t(L,{gutter:16},{default:e(()=>[t(k,{span:6},{default:e(()=>[l("div",Le,[u[7]||(u[7]=l("div",{class:"metric-label"},"夏普比率",-1)),l("div",Ie,r(n.value.performance.sharpe_ratio!==null?n.value.performance.sharpe_ratio.toFixed(4):"-"),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",Ue,[u[8]||(u[8]=l("div",{class:"metric-label"},"最大回撤",-1)),l("div",Pe,r(S(n.value.performance.max_drawdown)),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",Ee,[u[9]||(u[9]=l("div",{class:"metric-label"},"波动率",-1)),l("div",Me,r(n.value.performance.volatility!==null?S(n.value.performance.volatility):"-"),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",je,[u[10]||(u[10]=l("div",{class:"metric-label"},"总交易次数",-1)),l("div",He,r(n.value.performance.total_trades),1)])]),_:1})]),_:1}),t(L,{gutter:16},{default:e(()=>[t(k,{span:6},{default:e(()=>[l("div",Ae,[u[11]||(u[11]=l("div",{class:"metric-label"},"胜率",-1)),l("div",Ge,r(n.value.performance.win_rate!==null?S(n.value.performance.win_rate):"-"),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",Oe,[u[12]||(u[12]=l("div",{class:"metric-label"},"盈利交易",-1)),l("div",Ye,r(n.value.performance.winning_trades),1)])]),_:1}),t(k,{span:6},{default:e(()=>[l("div",qe,[u[13]||(u[13]=l("div",{class:"metric-label"},"亏损交易",-1)),l("div",Je,r(n.value.performance.losing_trades),1)])]),_:1}),t(k,{span:6})]),_:1})]),_:1}),n.value.detailed_data.trade_records.length>0?(v(),R(E,{key:0,class:"trades-card",shadow:"never"},{header:e(()=>[l("div",Ke,[u[14]||(u[14]=l("span",null,"交易记录",-1)),l("span",Qe,"共 "+r(n.value.detailed_data.trade_records.length)+" 笔交易",1)])]),default:e(()=>[t(Q,{data:n.value.detailed_data.trade_records,stripe:"",style:{width:"100%"},"max-height":"400"},{default:e(()=>[t(x,{prop:"datetime",label:"交易时间","min-width":"160"},{default:e(g=>[i(r(V(g.row.datetime)),1)]),_:1}),t(x,{prop:"type",label:"交易类型","min-width":"100"},{default:e(g=>[t(H,{type:g.row.type==="buy"?"success":"danger"},{default:e(()=>[i(r(g.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),t(x,{prop:"size",label:"数量","min-width":"100"}),t(x,{prop:"price",label:"价格","min-width":"120"},{default:e(g=>[i(r(h(g.row.price)),1)]),_:1}),t(x,{prop:"value",label:"交易金额","min-width":"140"},{default:e(g=>[i(r(h(g.row.value)),1)]),_:1}),t(x,{prop:"commission",label:"手续费","min-width":"120"},{default:e(g=>[i(r(h(g.row.commission)),1)]),_:1})]),_:1},8,["data"])]),_:1})):P("",!0)])):d.value?(v(),w("div",We,[t(W,{icon:"error",title:"加载失败","sub-title":d.value},{extra:e(()=>[t(A,{type:"primary",onClick:F},{default:e(()=>[...u[15]||(u[15]=[i("重试",-1)])]),_:1})]),_:1},8,["sub-title"])])):P("",!0)]),_:1},8,["model-value"])}}}),Ze=ie(Xe,[["__scopeId","data-v-ed8eda27"]]),et={class:"backtest-history-view"},tt={class:"filter-panel"},at={class:"card-header"},lt={class:"task-list"},st={class:"card-header"},ot={class:"header-actions"},nt={key:1},rt={key:0,class:"negative"},it={key:1},dt={class:"pagination-container"},ut={key:0,class:"task-detail"},ct={class:"negative"},_t={class:"task-actions",style:{"margin-top":"20px"}},mt=oe({__name:"BacktestHistoryView",setup(te){const K=ye(),m=X({strategyName:"",symbol:"",status:""}),f=X({page:1,pageSize:10,total:0}),n=y([]),N=y([]),d=y(null),F=y(!1),D=y(!1),h=y(!1),S=y(""),V=y(new Set),B=y(new Set),_=X({tasks:[]}),u=s=>{const a=N.value.find(p=>p.name===s);return a?a.description:s},C=async()=>{F.value=!0;try{const s={offset:(f.page-1)*f.pageSize,limit:f.pageSize,...m.strategyName&&{strategy_name:m.strategyName},...m.symbol&&{stock_code:m.symbol},...m.status&&{status:m.status}},a=await he(s);console.log("result.tasks",a.tasks),_.tasks=a.tasks||[],n.value=a.tasks||[],await ge(),f.total=a.total}catch(s){console.error("加载任务列表失败:",s),U.error("加载任务列表失败")}finally{F.value=!1}},b=async()=>{try{const s=await Ce();N.value=s}catch(s){console.error("加载策略列表失败:",s)}},j=()=>{f.page=1,C()},E=()=>{m.strategyName="",m.symbol="",m.status="",f.page=1,C()},k=()=>{C()},L=async s=>{V.value.add(s);try{if(await xe(s),U.success("回测任务已启动"),await C(),d.value&&d.value.task_id===s){const a=_.tasks.find(p=>p.task_id===s);a&&(d.value=a)}}catch(a){console.error("运行回测任务失败:",a),U.error("运行回测任务失败")}finally{V.value.delete(s)}},x=async s=>{B.value.add(s);try{const a=await $e(s),p=_.tasks.findIndex(I=>I.task_id===s);p!==-1&&(_.tasks[p].status=a.status,a.completed_at&&(_.tasks[p].completed_at=a.completed_at));const $=n.value.findIndex(I=>I.task_id===s);$!==-1&&(n.value[$].status=a.status,a.completed_at&&(n.value[$].completed_at=a.completed_at)),d.value&&d.value.task_id===s&&(d.value.status=a.status,a.completed_at&&(d.value.completed_at=a.completed_at)),U.success("状态已更新")}catch(a){console.error("查询任务状态失败:",a),U.error("查询任务状态失败")}finally{B.value.delete(s)}},H=s=>{K.push(`/backtest-result/${s}`)},Q=s=>{d.value=s,D.value=!0},A=s=>{f.pageSize=s,f.page=1,C()},W=s=>{f.page=s,C()},G=s=>{switch(s){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},g=s=>{switch(s){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},M=s=>s>0?"positive":s<0?"negative":"",O=s=>s==null?"-":`${s.toFixed(2)}%`,Y=s=>new Date(s).toLocaleString("zh-CN");return ee(n,s=>{console.log("taskList 发生变化，新长度:",s.length)},{deep:!0}),ee(()=>_.tasks,s=>{console.log("tableData.tasks 发生变化，新长度:",s.length),console.log("tableData.tasks 内容:",s)},{deep:!0}),fe(async()=>{await Promise.all([b(),C()])}),(s,a)=>{const p=c("el-button"),$=c("el-option"),I=c("el-select"),q=c("el-form-item"),de=c("el-input"),ue=c("el-form"),ae=c("el-card"),z=c("el-table-column"),le=c("el-tag"),ce=c("el-table"),_e=c("el-pagination"),T=c("el-descriptions-item"),me=c("el-descriptions"),pe=c("el-dialog"),ve=be("loading");return v(),w("div",et,[a[25]||(a[25]=l("div",{class:"page-header"},[l("h1",null,"回测历史"),l("p",null,"查看历史回测任务，监控状态和查看结果")],-1)),l("div",tt,[t(ae,null,{header:e(()=>[l("div",at,[a[13]||(a[13]=l("span",null,"筛选条件",-1)),t(p,{type:"primary",onClick:k},{default:e(()=>[...a[12]||(a[12]=[i("刷新",-1)])]),_:1})])]),default:e(()=>[t(ue,{model:m,inline:"",class:"filter-form"},{default:e(()=>[t(q,{label:"策略名称"},{default:e(()=>[t(I,{modelValue:m.strategyName,"onUpdate:modelValue":a[0]||(a[0]=o=>m.strategyName=o),placeholder:"全部策略",clearable:"",style:{width:"150px"}},{default:e(()=>[(v(!0),w(ne,null,re(N.value,o=>(v(),R($,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(q,{label:"股票代码"},{default:e(()=>[t(de,{modelValue:m.symbol,"onUpdate:modelValue":a[1]||(a[1]=o=>m.symbol=o),placeholder:"请输入股票代码",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),t(q,{label:"状态"},{default:e(()=>[t(I,{modelValue:m.status,"onUpdate:modelValue":a[2]||(a[2]=o=>m.status=o),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:e(()=>[t($,{label:"已创建",value:"created"}),t($,{label:"运行中",value:"running"}),t($,{label:"已完成",value:"completed"}),t($,{label:"执行失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),t(q,null,{default:e(()=>[t(p,{type:"primary",onClick:j},{default:e(()=>[...a[14]||(a[14]=[i("查询",-1)])]),_:1}),t(p,{onClick:E},{default:e(()=>[...a[15]||(a[15]=[i("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),l("div",lt,[t(ae,null,{header:e(()=>[l("div",st,[a[17]||(a[17]=l("span",null,"回测任务列表",-1)),l("div",ot,[t(p,{type:"primary",onClick:a[3]||(a[3]=o=>s.$router.push("/backtest-strategy"))},{default:e(()=>[...a[16]||(a[16]=[i("创建新任务",-1)])]),_:1})])])]),default:e(()=>[ke((v(),R(ce,{data:_.tasks,stripe:"",style:{width:"100%"},onRowClick:Q,class:"full-width-table"},{default:e(()=>[t(z,{prop:"task_id",label:"任务ID","min-width":"200","show-overflow-tooltip":""}),t(z,{label:"策略","min-width":"120"},{default:e(o=>[i(r(u(o.row.strategy_name)),1)]),_:1}),t(z,{prop:"stock_name",label:"股票","min-width":"100"}),t(z,{label:"状态",width:"100"},{default:e(o=>[t(le,{type:G(o.row.status)},{default:e(()=>[i(r(g(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(z,{label:"总收益率","min-width":"120"},{default:e(o=>[o.row.result_summary?.total_return!==void 0?(v(),w("span",{key:0,class:J(M(o.row.result_summary?.total_return))},r(O(o.row.result_summary?.total_return)),3)):(v(),w("span",nt,"-"))]),_:1}),t(z,{label:"最大回撤","min-width":"120"},{default:e(o=>[o.row.result_summary?.max_drawdown!==void 0?(v(),w("span",rt,r(O(o.row.result_summary?.max_drawdown)),1)):(v(),w("span",it,"-"))]),_:1}),t(z,{prop:"created_at",label:"创建时间","min-width":"180"},{default:e(o=>[i(r(Y(o.row.created_at)),1)]),_:1}),t(z,{prop:"completed_at",label:"完成时间","min-width":"180"},{default:e(o=>[i(r(o.row.completed_at?Y(o.row.completed_at):"-"),1)]),_:1}),t(z,{label:"操作","min-width":"250",fixed:"right"},{default:e(o=>[t(p,{type:"primary",size:"small",onClick:Z(se=>L(o.row.task_id),["stop"]),disabled:o.row.status!=="created",loading:V.value.has(o.row.task_id)},{default:e(()=>[...a[18]||(a[18]=[i(" 运行 ",-1)])]),_:2},1032,["onClick","disabled","loading"]),t(p,{type:"info",size:"small",onClick:Z(se=>x(o.row.task_id),["stop"]),loading:B.value.has(o.row.task_id)},{default:e(()=>[...a[19]||(a[19]=[i(" 查询状态 ",-1)])]),_:2},1032,["onClick","loading"]),t(p,{type:"success",size:"small",onClick:Z(se=>H(o.row.task_id),["stop"]),disabled:o.row.status!=="completed"},{default:e(()=>[...a[20]||(a[20]=[i(" 查看结果 ",-1)])]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[ve,F.value]]),l("div",dt,[t(_e,{"current-page":f.page,"onUpdate:currentPage":a[4]||(a[4]=o=>f.page=o),"page-size":f.pageSize,"onUpdate:pageSize":a[5]||(a[5]=o=>f.pageSize=o),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:A,onCurrentChange:W},null,8,["current-page","page-size","total"])])]),_:1})]),t(pe,{modelValue:D.value,"onUpdate:modelValue":a[10]||(a[10]=o=>D.value=o),title:"任务详情",width:"800px","close-on-click-modal":!1},{footer:e(()=>[t(p,{onClick:a[9]||(a[9]=o=>D.value=!1)},{default:e(()=>[...a[24]||(a[24]=[i("关闭",-1)])]),_:1})]),default:e(()=>[d.value?(v(),w("div",ut,[t(me,{column:2,border:""},{default:e(()=>[t(T,{label:"任务ID"},{default:e(()=>[i(r(d.value.task_id),1)]),_:1}),t(T,{label:"策略名称"},{default:e(()=>[i(r(d.value.strategy_name),1)]),_:1}),t(T,{label:"股票代码"},{default:e(()=>[i(r(d.value.stock_code),1)]),_:1}),t(T,{label:"状态"},{default:e(()=>[t(le,{type:G(d.value.status)},{default:e(()=>[i(r(g(d.value.status)),1)]),_:1},8,["type"])]),_:1}),t(T,{label:"创建时间"},{default:e(()=>[i(r(Y(d.value.created_at)),1)]),_:1}),t(T,{label:"完成时间"},{default:e(()=>[i(r(d.value.completed_at?Y(d.value.completed_at):"-"),1)]),_:1}),d.value.result_summary?.total_return!==void 0?(v(),R(T,{key:0,label:"总收益率"},{default:e(()=>[l("span",{class:J(M(d.value.result_summary?.total_return))},r(O(d.value.result_summary?.total_return)),3)]),_:1})):P("",!0),d.value.result_summary?.max_drawdown!==void 0?(v(),R(T,{key:1,label:"最大回撤"},{default:e(()=>[l("span",ct,r(O(d.value.result_summary?.max_drawdown??0)),1)]),_:1})):P("",!0)]),_:1}),l("div",_t,[t(p,{type:"primary",onClick:a[6]||(a[6]=o=>L(d.value.task_id)),disabled:d.value.status!=="created",loading:V.value.has(d.value.task_id)},{default:e(()=>[...a[21]||(a[21]=[i(" 运行任务 ",-1)])]),_:1},8,["disabled","loading"]),t(p,{type:"info",onClick:a[7]||(a[7]=o=>x(d.value.task_id)),loading:B.value.has(d.value.task_id)},{default:e(()=>[...a[22]||(a[22]=[i(" 刷新状态 ",-1)])]),_:1},8,["loading"]),t(p,{type:"success",onClick:a[8]||(a[8]=o=>H(d.value.task_id)),disabled:d.value.status!=="completed"},{default:e(()=>[...a[23]||(a[23]=[i(" 查看结果 ",-1)])]),_:1},8,["disabled"])])])):P("",!0)]),_:1},8,["modelValue"]),t(Ze,{visible:h.value,"onUpdate:visible":a[11]||(a[11]=o=>h.value=o),"task-id":S.value},null,8,["visible","task-id"])])}}}),ft=ie(mt,[["__scopeId","data-v-8a9d0a86"]]);export{ft as default};
