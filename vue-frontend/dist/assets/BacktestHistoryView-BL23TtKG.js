import{d as te,a as $,B as ee,f as F,w as t,i as c,c as b,g as J,e,k as d,t as r,b as l,F as ie,A as de,L as Y,E as L,o as p,_ as ae,z as re,r as X,y as ge,H as ye,D as be,G as ke,h as Z,u as we}from"./index-GxQC_MOV.js";import{b as he,d as Ce,g as $e,r as xe,a as Se}from"./quantBacktestApi-C9awQCeb.js";const ze={key:0,class:"loading-container"},De={key:1,class:"result-container"},Ve={key:0,class:"strategy-params"},Ne={class:"metric-item"},Te={class:"metric-value"},Be={class:"metric-item"},Le={class:"metric-value"},Re={class:"metric-item"},Fe={class:"metric-item"},Je={class:"metric-item"},Ue={class:"metric-value"},Ie={class:"metric-item"},Pe={class:"metric-value negative"},je={class:"metric-item"},Oe={class:"metric-value"},We={class:"metric-item"},Ee={class:"metric-value"},He={class:"metric-item"},Me={class:"metric-value"},qe={class:"metric-item"},Ae={class:"metric-value positive"},Ge={class:"metric-item"},Ye={class:"metric-value negative"},Ke={class:"card-header"},Qe={class:"trade-count"},Xe={key:2,class:"error-container"},Ze=te({__name:"BacktestResultDialog",props:{visible:{type:Boolean},taskId:{}},emits:["update:visible"],setup(W,{emit:P}){const m=W,g=P,n=$(null),h=$(!1),i=$(""),N=async()=>{if(!m.taskId){i.value="任务ID不能为空";return}h.value=!0,i.value="",n.value=null;try{n.value=await he(m.taskId)}catch(_){console.error("加载回测结果失败:",_),i.value=_.message||"加载回测结果失败",L.error("加载回测结果失败")}finally{h.value=!1}},v=()=>{g("update:visible",!1),n.value=null,i.value=""};ee(()=>m.visible,_=>{_&&m.taskId&&N()});const y=_=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}).format(_),S=_=>_==null?"-":`${_.toFixed(2)}%`,T=_=>new Date(_).toLocaleString("zh-CN"),R=_=>_>0?"positive":_<0?"negative":"";return(_,u)=>{const z=c("el-skeleton"),C=c("el-descriptions-item"),E=c("el-descriptions"),j=c("el-card"),w=c("el-col"),U=c("el-row"),D=c("el-table-column"),H=c("el-tag"),K=c("el-table"),M=c("el-button"),Q=c("el-result"),q=c("el-dialog");return p(),F(q,{"model-value":_.visible,"onUpdate:modelValue":v,title:"回测结果详情",width:"90%","close-on-click-modal":!1,"before-close":v},{footer:t(()=>[e(M,{onClick:v},{default:t(()=>[...u[16]||(u[16]=[d("关闭",-1)])]),_:1})]),default:t(()=>[h.value?(p(),b("div",ze,[e(z,{rows:10,animated:""})])):n.value?(p(),b("div",De,[e(j,{class:"info-card",shadow:"never"},{header:t(()=>[...u[0]||(u[0]=[l("div",{class:"card-header"},[l("span",null,"基本信息")],-1)])]),default:t(()=>[e(E,{column:3,border:""},{default:t(()=>[e(C,{label:"任务ID"},{default:t(()=>[d(r(n.value.task_info.task_id),1)]),_:1}),e(C,{label:"策略名称"},{default:t(()=>[d(r(n.value.task_info.strategy_name),1)]),_:1}),e(C,{label:"股票代码"},{default:t(()=>[d(r(n.value.task_info.stock_code),1)]),_:1}),e(C,{label:"股票名称"},{default:t(()=>[d(r(n.value.task_info.stock_name),1)]),_:1}),e(C,{label:"开始日期"},{default:t(()=>[d(r(n.value.task_info.start_date),1)]),_:1}),e(C,{label:"结束日期"},{default:t(()=>[d(r(n.value.task_info.end_date),1)]),_:1}),e(C,{label:"初始资金"},{default:t(()=>[d(r(y(n.value.task_info.initial_cash)),1)]),_:1}),e(C,{label:"手续费率"},{default:t(()=>[d(r(S(n.value.task_info.commission)),1)]),_:1}),e(C,{label:"创建时间"},{default:t(()=>[d(r(T(n.value.task_info.created_at)),1)]),_:1}),e(C,{label:"完成时间"},{default:t(()=>[d(r(T(n.value.task_info.completed_at)),1)]),_:1})]),_:1}),n.value.task_info.strategy_params&&Object.keys(n.value.task_info.strategy_params).length>0?(p(),b("div",Ve,[u[1]||(u[1]=l("h4",null,"策略参数",-1)),e(E,{column:2,border:""},{default:t(()=>[(p(!0),b(ie,null,de(n.value.task_info.strategy_params,(k,O)=>(p(),F(C,{key:O,label:O},{default:t(()=>[d(r(k),1)]),_:2},1032,["label"]))),128))]),_:1})])):J("",!0)]),_:1}),e(j,{class:"performance-card",shadow:"never"},{header:t(()=>[...u[2]||(u[2]=[l("div",{class:"card-header"},[l("span",null,"绩效指标")],-1)])]),default:t(()=>[e(U,{gutter:16},{default:t(()=>[e(w,{span:6},{default:t(()=>[l("div",Ne,[u[3]||(u[3]=l("div",{class:"metric-label"},"初始价值",-1)),l("div",Te,r(y(n.value.performance.initial_value)),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",Be,[u[4]||(u[4]=l("div",{class:"metric-label"},"最终价值",-1)),l("div",Le,r(y(n.value.performance.final_value)),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",Re,[u[5]||(u[5]=l("div",{class:"metric-label"},"总收益率",-1)),l("div",{class:Y(["metric-value",R(n.value.performance.total_return)])},r(S(n.value.performance.total_return)),3)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",Fe,[u[6]||(u[6]=l("div",{class:"metric-label"},"年化收益率",-1)),l("div",{class:Y(["metric-value",R(n.value.performance.annual_return)])},r(S(n.value.performance.annual_return)),3)])]),_:1})]),_:1}),e(U,{gutter:16},{default:t(()=>[e(w,{span:6},{default:t(()=>[l("div",Je,[u[7]||(u[7]=l("div",{class:"metric-label"},"夏普比率",-1)),l("div",Ue,r(n.value.performance.sharpe_ratio!==null?n.value.performance.sharpe_ratio.toFixed(4):"-"),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",Ie,[u[8]||(u[8]=l("div",{class:"metric-label"},"最大回撤",-1)),l("div",Pe,r(S(n.value.performance.max_drawdown)),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",je,[u[9]||(u[9]=l("div",{class:"metric-label"},"波动率",-1)),l("div",Oe,r(n.value.performance.volatility!==null?S(n.value.performance.volatility):"-"),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",We,[u[10]||(u[10]=l("div",{class:"metric-label"},"总交易次数",-1)),l("div",Ee,r(n.value.performance.total_trades),1)])]),_:1})]),_:1}),e(U,{gutter:16},{default:t(()=>[e(w,{span:6},{default:t(()=>[l("div",He,[u[11]||(u[11]=l("div",{class:"metric-label"},"胜率",-1)),l("div",Me,r(n.value.performance.win_rate!==null?S(n.value.performance.win_rate):"-"),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",qe,[u[12]||(u[12]=l("div",{class:"metric-label"},"盈利交易",-1)),l("div",Ae,r(n.value.performance.winning_trades),1)])]),_:1}),e(w,{span:6},{default:t(()=>[l("div",Ge,[u[13]||(u[13]=l("div",{class:"metric-label"},"亏损交易",-1)),l("div",Ye,r(n.value.performance.losing_trades),1)])]),_:1}),e(w,{span:6})]),_:1})]),_:1}),n.value.detailed_data.trade_records.length>0?(p(),F(j,{key:0,class:"trades-card",shadow:"never"},{header:t(()=>[l("div",Ke,[u[14]||(u[14]=l("span",null,"交易记录",-1)),l("span",Qe,"共 "+r(n.value.detailed_data.trade_records.length)+" 笔交易",1)])]),default:t(()=>[e(K,{data:n.value.detailed_data.trade_records,stripe:"",style:{width:"100%"},"max-height":"400"},{default:t(()=>[e(D,{prop:"datetime",label:"交易时间","min-width":"160"},{default:t(k=>[d(r(T(k.row.datetime)),1)]),_:1}),e(D,{prop:"type",label:"交易类型","min-width":"100"},{default:t(k=>[e(H,{type:k.row.type==="buy"?"success":"danger"},{default:t(()=>[d(r(k.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),e(D,{prop:"size",label:"数量","min-width":"100"}),e(D,{prop:"price",label:"价格","min-width":"120"},{default:t(k=>[d(r(y(k.row.price)),1)]),_:1}),e(D,{prop:"value",label:"交易金额","min-width":"140"},{default:t(k=>[d(r(y(k.row.value)),1)]),_:1}),e(D,{prop:"commission",label:"手续费","min-width":"120"},{default:t(k=>[d(r(y(k.row.commission)),1)]),_:1})]),_:1},8,["data"])]),_:1})):J("",!0)])):i.value?(p(),b("div",Xe,[e(Q,{icon:"error",title:"加载失败","sub-title":i.value},{extra:t(()=>[e(M,{type:"primary",onClick:N},{default:t(()=>[...u[15]||(u[15]=[d("重试",-1)])]),_:1})]),_:1},8,["sub-title"])])):J("",!0)]),_:1},8,["model-value"])}}}),et=ae(Ze,[["__scopeId","data-v-ed8eda27"]]),tt={class:"json-preview-inline"},at={class:"json-pre"},lt={key:0,class:"actions"},st=te({__name:"JsonPreview",props:{value:{},showCopy:{type:Boolean,default:!0}},emits:["copy"],setup(W,{emit:P}){const m=W,g=P;function n(v){if(v==null)return v;if(typeof v=="string"){const y=v.trim();if(y.startsWith("{")&&y.endsWith("}")||y.startsWith("[")&&y.endsWith("]"))try{return JSON.parse(y)}catch{return v}return v}return v}const h=re(()=>n(m.value)),i=re(()=>{try{return typeof h.value=="object"?JSON.stringify(h.value,null,2):typeof h.value=="string"?h.value:String(h.value)}catch{return String(m.value??"")}}),N=async()=>{try{const v=i.value;await navigator.clipboard.writeText(v),g("copy",v),L.success("已复制 JSON")}catch{L.error("复制失败")}};return(v,y)=>{const S=c("el-button");return p(),b("div",tt,[l("pre",at,r(i.value),1),v.showCopy?(p(),b("div",lt,[e(S,{size:"small",type:"primary",onClick:N},{default:t(()=>[...y[0]||(y[0]=[d("复制JSON",-1)])]),_:1})])):J("",!0)])}}}),ot=ae(st,[["__scopeId","data-v-fadd9fb2"]]),nt={class:"backtest-history-view"},rt={class:"filter-panel"},it={class:"card-header"},dt={class:"task-list"},ut={class:"card-header"},ct={class:"header-actions"},_t={key:1},mt={key:0,class:"negative"},pt={key:1},vt={key:0,class:"positive"},ft={key:1},gt={class:"pagination-container"},yt={key:0,class:"task-detail"},bt={class:"negative"},kt={class:"task-actions",style:{"margin-top":"20px"}},wt=te({__name:"BacktestHistoryView",setup(W){const P=we(),m=X({strategyName:"",symbol:"",status:""}),g=X({page:1,pageSize:10,total:0}),n=$([]),h=$([]),i=$(null),N=$(!1),v=$(!1),y=$(!1),S=$(""),T=$(new Set),R=$(new Set),_=X({tasks:[]}),u=s=>{const a=h.value.find(f=>f.name===s);return a?a.description:s},z=async()=>{N.value=!0;try{const s={offset:(g.page-1)*g.pageSize,limit:g.pageSize,...m.strategyName&&{strategy_name:m.strategyName},...m.symbol&&{stock_code:m.symbol},...m.status&&{status:m.status}},a=await Ce(s);console.log("result.tasks",a.tasks),_.tasks=a.tasks||[],n.value=a.tasks||[],await ye(),g.total=a.total}catch(s){console.error("加载任务列表失败:",s),L.error("加载任务列表失败")}finally{N.value=!1}},C=async()=>{try{const s=await $e();h.value=s}catch(s){console.error("加载策略列表失败:",s)}},E=()=>{g.page=1,z()},j=()=>{m.strategyName="",m.symbol="",m.status="",g.page=1,z()},w=()=>{z()},U=async s=>{T.value.add(s);try{if(await xe(s),L.success("回测任务已启动"),await z(),i.value&&i.value.task_id===s){const a=_.tasks.find(f=>f.task_id===s);a&&(i.value=a)}}catch(a){console.error("运行回测任务失败:",a),L.error("运行回测任务失败")}finally{T.value.delete(s)}},D=async s=>{R.value.add(s);try{const a=await Se(s),f=_.tasks.findIndex(I=>I.task_id===s);f!==-1&&(_.tasks[f].status=a.status,a.completed_at&&(_.tasks[f].completed_at=a.completed_at));const V=n.value.findIndex(I=>I.task_id===s);V!==-1&&(n.value[V].status=a.status,a.completed_at&&(n.value[V].completed_at=a.completed_at)),i.value&&i.value.task_id===s&&(i.value.status=a.status,a.completed_at&&(i.value.completed_at=a.completed_at)),L.success("状态已更新")}catch(a){console.error("查询任务状态失败:",a),L.error("查询任务状态失败")}finally{R.value.delete(s)}},H=s=>{P.push(`/backtest-result/${s}`)},K=s=>{i.value=s,v.value=!0},M=s=>{g.pageSize=s,g.page=1,z()},Q=s=>{g.page=s,z()},q=s=>{switch(s){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},k=s=>{switch(s){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},O=s=>s>0?"positive":s<0?"negative":"",A=s=>s==null?"-":`${s.toFixed(2)}%`,le=s=>new Date(s).toLocaleString("zh-CN");return ee(n,s=>{console.log("taskList 发生变化，新长度:",s.length)},{deep:!0}),ee(()=>_.tasks,s=>{console.log("tableData.tasks 发生变化，新长度:",s.length),console.log("tableData.tasks 内容:",s)},{deep:!0}),ge(async()=>{await Promise.all([C(),z()])}),(s,a)=>{const f=c("el-button"),V=c("el-option"),I=c("el-select"),G=c("el-form-item"),ue=c("el-input"),ce=c("el-form"),se=c("el-card"),x=c("el-table-column"),oe=c("el-tag"),_e=c("el-table"),me=c("el-pagination"),B=c("el-descriptions-item"),pe=c("el-descriptions"),ve=c("el-dialog"),fe=ke("loading");return p(),b("div",nt,[a[25]||(a[25]=l("div",{class:"page-header"},[l("h1",null,"回测历史"),l("p",null,"查看历史回测任务，监控状态和查看结果")],-1)),l("div",rt,[e(se,null,{header:t(()=>[l("div",it,[a[13]||(a[13]=l("span",null,"筛选条件",-1)),e(f,{type:"primary",onClick:w},{default:t(()=>[...a[12]||(a[12]=[d("刷新",-1)])]),_:1})])]),default:t(()=>[e(ce,{model:m,inline:"",class:"filter-form"},{default:t(()=>[e(G,{label:"策略名称"},{default:t(()=>[e(I,{modelValue:m.strategyName,"onUpdate:modelValue":a[0]||(a[0]=o=>m.strategyName=o),placeholder:"全部策略",clearable:"",style:{width:"150px"}},{default:t(()=>[(p(!0),b(ie,null,de(h.value,o=>(p(),F(V,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(G,{label:"股票代码"},{default:t(()=>[e(ue,{modelValue:m.symbol,"onUpdate:modelValue":a[1]||(a[1]=o=>m.symbol=o),placeholder:"请输入股票代码",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(G,{label:"状态"},{default:t(()=>[e(I,{modelValue:m.status,"onUpdate:modelValue":a[2]||(a[2]=o=>m.status=o),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:t(()=>[e(V,{label:"已创建",value:"created"}),e(V,{label:"运行中",value:"running"}),e(V,{label:"已完成",value:"completed"}),e(V,{label:"执行失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),e(G,null,{default:t(()=>[e(f,{type:"primary",onClick:E},{default:t(()=>[...a[14]||(a[14]=[d("查询",-1)])]),_:1}),e(f,{onClick:j},{default:t(()=>[...a[15]||(a[15]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),l("div",dt,[e(se,null,{header:t(()=>[l("div",ut,[a[17]||(a[17]=l("span",null,"回测任务列表",-1)),l("div",ct,[e(f,{type:"primary",onClick:a[3]||(a[3]=o=>s.$router.push("/backtest-strategy"))},{default:t(()=>[...a[16]||(a[16]=[d("创建新任务",-1)])]),_:1})])])]),default:t(()=>[be((p(),F(_e,{data:_.tasks,stripe:"",style:{width:"100%"},onRowClick:K,class:"full-width-table"},{default:t(()=>[e(x,{prop:"stock_code",label:"股票代码","min-width":"100",align:"center"}),e(x,{prop:"stock_name",label:"股票名称","min-width":"100",align:"center"}),e(x,{label:"策略","min-width":"120",align:"center"},{default:t(o=>[d(r(u(o.row.strategy_name)),1)]),_:1}),e(x,{label:"状态",width:"80",align:"center"},{default:t(o=>[e(oe,{type:q(o.row.status)},{default:t(()=>[d(r(k(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),e(x,{label:"回测时间范围","min-width":"100",align:"center"},{default:t(o=>[l("div",null,r(o.row.start_date),1),l("div",null,r(o.row.end_date),1)]),_:1}),e(x,{prop:"frequency",label:"回测数据频率","min-width":"100",align:"center"}),e(x,{label:"策略参数","min-width":"240",align:"center"},{default:t(o=>[e(ot,{value:o.row.strategy_params,"max-inline-length":120},null,8,["value"])]),_:1}),e(x,{label:"总收益率","min-width":"120",align:"center"},{default:t(o=>[o.row.result_summary?.total_return!==void 0?(p(),b("span",{key:0,class:Y(O(o.row.result_summary?.total_return))},r(A(o.row.result_summary?.total_return)),3)):(p(),b("span",_t,"-"))]),_:1}),e(x,{label:"最大回撤","min-width":"100"},{default:t(o=>[o.row.result_summary?.max_drawdown!==void 0?(p(),b("span",mt,r(A(o.row.result_summary?.max_drawdown)),1)):(p(),b("span",pt,"-"))]),_:1}),e(x,{label:"夏普比率","min-width":"100"},{default:t(o=>[o.row.result_summary?.sharpe_ratio!==void 0?(p(),b("span",vt,r(o.row.result_summary?.sharpe_ratio),1)):(p(),b("span",ft,"-"))]),_:1}),e(x,{label:"操作","min-width":"250",fixed:"right",align:"center"},{default:t(o=>[e(f,{type:"primary",size:"small",onClick:Z(ne=>U(o.row.task_id),["stop"]),disabled:o.row.status!=="created",loading:T.value.has(o.row.task_id)},{default:t(()=>[...a[18]||(a[18]=[d(" 运行 ",-1)])]),_:2},1032,["onClick","disabled","loading"]),e(f,{type:"info",size:"small",onClick:Z(ne=>D(o.row.task_id),["stop"]),loading:R.value.has(o.row.task_id)},{default:t(()=>[...a[19]||(a[19]=[d(" 查询状态 ",-1)])]),_:2},1032,["onClick","loading"]),e(f,{type:"success",size:"small",onClick:Z(ne=>H(o.row.task_id),["stop"]),disabled:o.row.status!=="completed"},{default:t(()=>[...a[20]||(a[20]=[d(" 查看结果 ",-1)])]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[fe,N.value]]),l("div",gt,[e(me,{"current-page":g.page,"onUpdate:currentPage":a[4]||(a[4]=o=>g.page=o),"page-size":g.pageSize,"onUpdate:pageSize":a[5]||(a[5]=o=>g.pageSize=o),"page-sizes":[10,20,50,100],total:g.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M,onCurrentChange:Q},null,8,["current-page","page-size","total"])])]),_:1})]),e(ve,{modelValue:v.value,"onUpdate:modelValue":a[10]||(a[10]=o=>v.value=o),title:"任务详情",width:"800px","close-on-click-modal":!1},{footer:t(()=>[e(f,{onClick:a[9]||(a[9]=o=>v.value=!1)},{default:t(()=>[...a[24]||(a[24]=[d("关闭",-1)])]),_:1})]),default:t(()=>[i.value?(p(),b("div",yt,[e(pe,{column:2,border:""},{default:t(()=>[e(B,{label:"任务ID"},{default:t(()=>[d(r(i.value.task_id),1)]),_:1}),e(B,{label:"策略名称"},{default:t(()=>[d(r(i.value.strategy_name),1)]),_:1}),e(B,{label:"股票代码"},{default:t(()=>[d(r(i.value.stock_code),1)]),_:1}),e(B,{label:"状态"},{default:t(()=>[e(oe,{type:q(i.value.status)},{default:t(()=>[d(r(k(i.value.status)),1)]),_:1},8,["type"])]),_:1}),e(B,{label:"创建时间"},{default:t(()=>[d(r(le(i.value.created_at)),1)]),_:1}),e(B,{label:"完成时间"},{default:t(()=>[d(r(i.value.completed_at?le(i.value.completed_at):"-"),1)]),_:1}),i.value.result_summary?.total_return!==void 0?(p(),F(B,{key:0,label:"总收益率"},{default:t(()=>[l("span",{class:Y(O(i.value.result_summary?.total_return))},r(A(i.value.result_summary?.total_return)),3)]),_:1})):J("",!0),i.value.result_summary?.max_drawdown!==void 0?(p(),F(B,{key:1,label:"最大回撤"},{default:t(()=>[l("span",bt,r(A(i.value.result_summary?.max_drawdown??0)),1)]),_:1})):J("",!0)]),_:1}),l("div",kt,[e(f,{type:"primary",onClick:a[6]||(a[6]=o=>U(i.value.task_id)),disabled:i.value.status!=="created",loading:T.value.has(i.value.task_id)},{default:t(()=>[...a[21]||(a[21]=[d(" 运行任务 ",-1)])]),_:1},8,["disabled","loading"]),e(f,{type:"info",onClick:a[7]||(a[7]=o=>D(i.value.task_id)),loading:R.value.has(i.value.task_id)},{default:t(()=>[...a[22]||(a[22]=[d(" 刷新状态 ",-1)])]),_:1},8,["loading"]),e(f,{type:"success",onClick:a[8]||(a[8]=o=>H(i.value.task_id)),disabled:i.value.status!=="completed"},{default:t(()=>[...a[23]||(a[23]=[d(" 查看结果 ",-1)])]),_:1},8,["disabled"])])])):J("",!0)]),_:1},8,["modelValue"]),e(et,{visible:y.value,"onUpdate:visible":a[11]||(a[11]=o=>y.value=o),"task-id":S.value},null,8,["visible","task-id"])])}}}),$t=ae(wt,[["__scopeId","data-v-43a70fed"]]);export{$t as default};
