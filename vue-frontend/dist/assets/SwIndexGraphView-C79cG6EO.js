import{d as T,a as D,y as j,c as h,e as y,w as f,i as b,x as q,f as z,g,b as o,t as d,K as k,k as E,u as I,o as u,_ as K}from"./index-DBlIMAuh.js";import{b as F}from"./industryApi-Dj1_omis.js";const R={class:"sw-index-graph-view"},H={class:"card-header"},J={key:2,class:"table-container"},O={class:"cell-content"},Q={class:"index-name"},U={key:0,class:"index-code"},X={key:1,class:"valuation-info"},Z={class:"valuation-item"},w={class:"valuation-item"},ee={class:"action-btn"},te={key:0,class:"cell-content"},le={class:"index-name"},ne={key:0,class:"index-code"},se={key:1,class:"valuation-info"},ae={class:"valuation-item"},oe={class:"valuation-item"},ce={class:"action-btn"},ie={key:0,class:"cell-content"},de={class:"index-name"},re={key:0,class:"index-code"},pe={key:1,class:"valuation-info"},_e={class:"valuation-item"},ue={class:"valuation-item"},he={class:"action-btn"},fe=T({__name:"SwIndexGraphView",setup(ve){const N=I(),S=D(!1),C=D(""),M=D([]),m={l1:[],l2:[]},P=t=>{const s=t.getFullYear(),c=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0");return`${s}${c}${l}`},x=t=>t==null?{}:t>=80?{color:"#F56C6C",fontWeight:"bold"}:t<=20?{color:"#67C23A",fontWeight:"bold"}:{color:"#409EFF",fontWeight:"bold"},_=t=>t!=null?t.toFixed(2):"--",B=async()=>{S.value=!0,C.value="";try{const s=(await q.get("/django/api/index/sw-index-classify/",{params:{src:"SW2021"}})).data?.records||[],c=new Date,l=new Date;l.setFullYear(l.getFullYear()-5);const p={start_date:P(l),end_date:P(c)},a=(n,A)=>{const $=new Map(A.map(v=>[v.ts_code,v]));n.forEach(v=>{const L=$.get(v.index_code)||$.get(v.industry_code);L&&(v.pe=L.pe,v.pe_percentile=L.pe_percentile,v.pb=L.pb,v.pb_percentile=L.pb_percentile)})},i=[],r=[],e=[];s.forEach(n=>{n.level==="L1"?i.push(n):n.level==="L2"?r.push(n):n.level==="L3"&&e.push(n)});try{const n=await F({...p,level:"L1"});Array.isArray(n)&&a(i,n)}catch(n){console.error("Failed to fetch L1 valuation",n)}try{const n=await F({...p,level:"L2"});Array.isArray(n)&&a(r,n)}catch(n){console.error("Failed to fetch L2 valuation",n)}try{const n=await F({...p,level:"L3"});Array.isArray(n)&&a(e,n)}catch(n){console.error("Failed to fetch L3 valuation",n)}W(s)}catch(t){C.value=t.message||"获取数据失败"}finally{S.value=!1}},W=t=>{const s=[],c=new Map,l=new Map;t.forEach(a=>{if(a.level==="L1")s.push(a);else if(a.level==="L2"){const i=a.parent_code;c.has(i)||c.set(i,[]),c.get(i)?.push(a)}else if(a.level==="L3"){const i=a.parent_code;l.has(i)||l.set(i,[]),l.get(i)?.push(a)}});const p=[];s.sort((a,i)=>a.index_code.localeCompare(i.index_code)),s.forEach(a=>{let i=c.get(a.index_code)||[];if(i.length===0&&a.industry_code&&(i=c.get(a.industry_code)||[]),i.length===0){p.push({l1:a,l2:null,l3:null});return}i.sort((r,e)=>r.index_code.localeCompare(e.index_code)),i.forEach(r=>{let e=l.get(r.index_code)||[];if(e.length===0&&r.industry_code&&(e=l.get(r.industry_code)||[]),e.length===0){p.push({l1:a,l2:r,l3:null});return}e.sort((n,A)=>n.index_code.localeCompare(A.index_code)),e.forEach(n=>{p.push({l1:a,l2:r,l3:n})})})}),M.value=p,Y(p)},Y=t=>{m.l1=new Array(t.length).fill(0),m.l2=new Array(t.length).fill(0);let s=0,c=0;for(let l=0;l<t.length;l++){(l===0||t[l].l1?.index_code!==t[l-1].l1?.index_code)&&(l>0&&(m.l1[s]=l-s),s=l);const p=t[l].l2?.index_code,a=t[l-1]?.l2?.index_code,i=t[l].l1?.index_code,r=t[l-1]?.l1?.index_code;(l===0||p!==a||i!==r)&&(l>0&&(m.l2[c]=l-c),c=l)}m.l1[s]=t.length-s,m.l2[c]=t.length-c},G=({rowIndex:t,columnIndex:s})=>{if(s===0){const c=m.l1[t];return c>0?{rowspan:c,colspan:1}:{rowspan:0,colspan:0}}else if(s===1){const c=m.l2[t];return c>0?{rowspan:c,colspan:1}:{rowspan:0,colspan:0}}},V=t=>{N.push({name:"sw-industry-daily",query:{ts_code:t.index_code,industry_name:t.industry_name}})};return j(()=>{B()}),(t,s)=>{const c=b("el-button"),l=b("el-alert"),p=b("el-skeleton"),a=b("el-table-column"),i=b("el-table"),r=b("el-card");return u(),h("div",R,[y(r,{shadow:"hover"},{header:f(()=>[o("div",H,[s[1]||(s[1]=o("span",null,"申万指数图谱",-1)),y(c,{type:"primary",loading:S.value,onClick:B,size:"small"},{default:f(()=>[...s[0]||(s[0]=[E("刷新",-1)])]),_:1},8,["loading"])])]),default:f(()=>[C.value?(u(),z(l,{key:0,type:"error",closable:!1,title:C.value,class:"mb-12"},null,8,["title"])):g("",!0),S.value&&!C.value?(u(),z(p,{key:1,rows:"10",animated:""})):(u(),h("div",J,[y(i,{data:M.value,border:"",style:{width:"100%"},"span-method":G,height:"calc(100vh - 200px)"},{default:f(()=>[y(a,{label:"一级行业","min-width":"250",align:"center"},{default:f(({row:e})=>[o("div",O,[o("span",Q,d(e.l1?.industry_name),1),e.l1?.index_code?(u(),h("span",U,"("+d(e.l1?.index_code)+")",1)):g("",!0),e.l1?.pe!==void 0?(u(),h("div",X,[o("div",Z,[o("span",null,"PE: "+d(_(e.l1?.pe)),1),o("span",{style:k(x(e.l1?.pe_percentile)),class:"percentile"},"("+d(_(e.l1?.pe_percentile))+"%)",5)]),o("div",w,[o("span",null,"PB: "+d(_(e.l1?.pb)),1),o("span",{style:k(x(e.l1?.pb_percentile)),class:"percentile"},"("+d(_(e.l1?.pb_percentile))+"%)",5)])])):g("",!0),o("div",ee,[y(c,{link:"",type:"primary",size:"small",onClick:n=>V(e.l1)},{default:f(()=>[...s[2]||(s[2]=[E("查看趋势",-1)])]),_:2},1032,["onClick"])])])]),_:1}),y(a,{label:"二级行业","min-width":"250",align:"center"},{default:f(({row:e})=>[e.l2?(u(),h("div",te,[o("span",le,d(e.l2?.industry_name),1),e.l2?.index_code?(u(),h("span",ne,"("+d(e.l2?.index_code)+")",1)):g("",!0),e.l2?.pe!==void 0?(u(),h("div",se,[o("div",ae,[o("span",null,"PE: "+d(_(e.l2?.pe)),1),o("span",{style:k(x(e.l2?.pe_percentile)),class:"percentile"},"("+d(_(e.l2?.pe_percentile))+"%)",5)]),o("div",oe,[o("span",null,"PB: "+d(_(e.l2?.pb)),1),o("span",{style:k(x(e.l2?.pb_percentile)),class:"percentile"},"("+d(_(e.l2?.pb_percentile))+"%)",5)])])):g("",!0),o("div",ce,[y(c,{link:"",type:"primary",size:"small",onClick:n=>V(e.l2)},{default:f(()=>[...s[3]||(s[3]=[E("查看趋势",-1)])]),_:2},1032,["onClick"])])])):g("",!0)]),_:1}),y(a,{label:"三级行业","min-width":"250",align:"center"},{default:f(({row:e})=>[e.l3?(u(),h("div",ie,[o("span",de,d(e.l3?.industry_name),1),e.l3?.index_code?(u(),h("span",re,"("+d(e.l3?.index_code)+")",1)):g("",!0),e.l3?.pe!==void 0?(u(),h("div",pe,[o("div",_e,[o("span",null,"PE: "+d(_(e.l3?.pe)),1),o("span",{style:k(x(e.l3?.pe_percentile)),class:"percentile"},"("+d(_(e.l3?.pe_percentile))+"%)",5)]),o("div",ue,[o("span",null,"PB: "+d(_(e.l3?.pb)),1),o("span",{style:k(x(e.l3?.pb_percentile)),class:"percentile"},"("+d(_(e.l3?.pb_percentile))+"%)",5)])])):g("",!0),o("div",he,[y(c,{link:"",type:"primary",size:"small",onClick:n=>V(e.l3)},{default:f(()=>[...s[4]||(s[4]=[E("查看趋势",-1)])]),_:2},1032,["onClick"])])])):g("",!0)]),_:1})]),_:1},8,["data"])]))]),_:1})])}}}),me=K(fe,[["__scopeId","data-v-3707cc62"]]);export{me as default};
